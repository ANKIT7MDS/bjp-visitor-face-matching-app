<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WedMatch ‚Äì Face Search</title>
  <style>
    body{font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Noto Sans, 'Apple Color Emoji','Segoe UI Emoji';margin:0;background:#fafafa;color:#222}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;padding:10px 14px;z-index:10}
    main{display:grid;grid-template-columns:420px 1fr;gap:18px;max-width:1300px;margin:16px auto;padding:0 14px}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .card h3{margin:0;padding:12px 14px;border-bottom:1px solid #f0f0f0}
    .card .content{padding:12px 14px}
    label{display:block;font-size:12px;color:#555;margin:8px 0 6px}
    input[type=text]{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px;font-size:14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{appearance:none;border:0;outline:0;background:#0b5fff;color:#fff;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:600}
    .btn.secondary{background:#f3f4f6;color:#111;border:1px solid #e5e7eb}
    .hint{font-size:12px;color:#666}
    video,canvas,.snap{width:100%;border-radius:12px;background:#000}
    .grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(240px,1fr));gap:14px}
    .result{border:1px solid #eee;border-radius:12px;overflow:hidden;background:#fff}
    .result .meta{padding:8px 10px;border-top:1px solid #f2f2f2}
    .pill{display:inline-block;font-size:12px;padding:2px 8px;border-radius:999px;background:#f5f5f5}
    .toolbar{display:flex;gap:8px;align-items:center;margin-top:8px}
    .thumb{display:block;width:100%;height:240px;object-fit:cover;background:#f6f7f8}
    .footer-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
    .muted{color:#777}
  </style>
</head>
<body>
<header>
  <strong>WedMatch</strong>
</header>

<main>
  <!-- Left: controls -->
  <section class="card">
    <h3>‡§ñ‡•ã‡§ú</h3>
    <div class="content">
      <div class="row">
        <div>
          <label>‡§®‡§æ‡§Æ (optional)</label>
          <input id="name" type="text" placeholder="‡§ú‡•à‡§∏‡•á: ‡§∞‡•ã‡§π‡§ø‡§§" />
        </div>
        <div>
          <label>‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ (optional)</label>
          <input id="phone" type="text" placeholder="‡§ú‡•à‡§∏‡•á: 98930‚Ä¶" />
        </div>
      </div>

      <label>Event IDs (comma-separated, optional)</label>
      <input id="eventIds" type="text" placeholder="EVT_2025_08_12, demo-2025-01" />

      <div style="margin-top:10px"></div>
      <label>‡§∏‡•á‡§≤‡•ç‡§´‡§º‡•Ä ‡§ï‡•à‡§Æ‡§∞‡§æ</label>
      <video id="video" autoplay playsinline muted class="snap"></video>
      <div class="toolbar">
        <button class="btn secondary" id="btnCam">‡§ï‡•à‡§Æ‡§∞‡§æ ‡§ö‡§æ‡§≤‡•Ç ‡§ï‡§∞‡•á‡§Ç</button>
        <span id="camState" class="hint">‚Äî</span>
      </div>

      <div style="margin-top:10px"></div>
      <label>‡§Ø‡§æ ‡§´‡§º‡§æ‡§á‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç</label>
      <input id="file" type="file" accept="image/*" />
      <div class="hint">PNG/JPEG/WebP ‡§ö‡§≤‡•á‡§Ç‡§ó‡•á ‚Äî ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§™‡§∞ ‡§ï‡•à‡§Æ‡§∞‡§æ easiest ‡§π‡•à‡•§</div>

      <div class="footer-actions">
        <button id="btnSearch" class="btn">Search</button>
      </div>

      <div class="hint" id="dbg"></div>
    </div>
  </section>

  <!-- Right: results -->
  <section class="card">
    <h3>‡§™‡§∞‡§ø‡§£‡§æ‡§Æ</h3>
    <div class="content">
      <div id="status" class="muted">Ready.</div>
      <div id="results" class="grid" style="margin-top:10px"></div>
      <div class="footer-actions">
        <button id="btnMore" class="btn secondary" style="display:none">‡§î‡§∞ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å</button>
      </div>
    </div>
  </section>
</main>

<script>
// ====== üîß CONFIG ‚Äì ‡§Ö‡§™‡§®‡•á API Gateway ‡§ï‡§æ base URL ‡§Ø‡§π‡§æ‡§Å ‡§¶‡•á‡§Ç ======
const API_BASE = 'https://oidwg6gcx0.execute-api.ap-south-1.amazonaws.com/PROD2';
const ENDPOINTS = {
  search: API_BASE + '/search',
  thumb:  API_BASE + '/thumb',
  download: API_BASE + '/download'
};
// =============================================================

const els = {
  name: document.getElementById('name'),
  phone: document.getElementById('phone'),
  eventIds: document.getElementById('eventIds'),
  video: document.getElementById('video'),
  camBtn: document.getElementById('btnCam'),
  camState: document.getElementById('camState'),
  file: document.getElementById('file'),
  search: document.getElementById('btnSearch'),
  results: document.getElementById('results'),
  status: document.getElementById('status'),
  more: document.getElementById('btnMore'),
  dbg: document.getElementById('dbg')
};

let mediaStream = null;
let nextToken = null;
let lastPayload = null;

// ---------- Camera ----------
async function startCamera(){
  try {
    mediaStream = await navigator.mediaDevices.getUserMedia({video: {facingMode: 'user'}});
    els.video.srcObject = mediaStream;
    els.camState.textContent = 'camera started';
  } catch (err){
    console.error(err);
    els.camState.textContent = '‡§ï‡•à‡§Æ‡§∞‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§ñ‡•Å‡§≤‡§æ: ' + err.message;
  }
}

function stopCamera(){
  if (mediaStream){
    mediaStream.getTracks().forEach(t => t.stop());
    mediaStream = null;
    els.camState.textContent = 'camera stopped';
  }
}

function captureFromVideo(){
  if (!mediaStream) return null;
  const v = els.video;
  const w = v.videoWidth || 640;
  const h = v.videoHeight || 640;
  const maxSide = 1280;
  const scale = Math.min(1, maxSide/Math.max(w,h));
  const cw = Math.round(w*scale), ch = Math.round(h*scale);
  const c = document.createElement('canvas');
  c.width = cw; c.height = ch;
  const ctx = c.getContext('2d');
  ctx.drawImage(v, 0, 0, cw, ch);
  // JPEG keeps size small + EXIF ignored (thumbnail lambda can rotate)
  return c.toDataURL('image/jpeg', 0.9);
}

// ---------- File helpers ----------
function readAsDataURL(file){
  return new Promise((res, rej)=>{
    const fr = new FileReader();
    fr.onerror = rej;
    fr.onload = ()=> res(fr.result);
    fr.readAsDataURL(file);
  });
}

async function dataURLFromFile(file){
  const raw = await readAsDataURL(file);
  // Downscale big images for network friendliness
  return await downscaleIfNeeded(raw);
}

async function downscaleIfNeeded(dataUrl){
  try {
    const img = new Image();
    img.src = dataUrl;
    await img.decode();
    const w = img.naturalWidth, h = img.naturalHeight;
    const MAX = 1280;
    if (Math.max(w,h) <= MAX) return dataUrl; // fine
    const scale = MAX/Math.max(w,h);
    const cw = Math.round(w*scale), ch = Math.round(h*scale);
    const c = document.createElement('canvas');
    c.width = cw; c.height = ch;
    const ctx = c.getContext('2d');
    ctx.drawImage(img, 0, 0, cw, ch);
    return c.toDataURL('image/jpeg', 0.9);
  } catch(e){
    console.warn('downscale skip', e);
    return dataUrl;
  }
}

// ---------- Network ----------
async function fetchJSON(url, body){
  const res = await fetch(url, {
    method: 'POST',
    headers: { 'content-type': 'application/json' },
    body: JSON.stringify(body)
  });
  if (!res.ok){
    const text = await res.text().catch(()=> '');
    throw new Error(`HTTP ${res.status}: ${text || res.statusText}`);
  }
  return res.json();
}

function renderResults(items){
  for (const it of items){
    const div = document.createElement('div');
    div.className = 'result';

    const img = document.createElement('img');
    img.className = 'thumb';
    img.alt = it.photoId || it.key || 'photo';
    const key = it.key || it.s3Key || it.photoKey; // defensive
    img.src = `${ENDPOINTS.thumb}?key=${encodeURIComponent(key)}&w=360&orient=1`;

    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.innerHTML = `
      <div><span class="pill">~${Math.round((it.score || it.similarity || 1)*100)}%</span> match</div>
      <div class="muted" style="word-break:break-all">ID: ${it.photoId || key}</div>
    `;

    div.appendChild(img);
    div.appendChild(meta);
    els.results.appendChild(div);
  }
}

function setStatus(t){ els.status.textContent = t; }

async function doSearch(next=false){
  try{
    els.search.disabled = true; setStatus('‡§ñ‡•ã‡§ú ‡§ú‡§æ‡§∞‡•Ä‚Ä¶');

    let imageDataURL = null;
    // 1) priority to selected file
    const f = els.file.files && els.file.files[0];
    if (f){ imageDataURL = await dataURLFromFile(f); }
    else if (mediaStream){ imageDataURL = captureFromVideo(); }

    if (!imageDataURL) throw new Error('‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§ö‡§æ‡§≤‡•Ç ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ ‡§è‡§ï ‡§´‡•ã‡§ü‡•ã ‡§ö‡•Å‡§®‡•á‡§Ç');

    const payload = next ? lastPayload : {
      name: els.name.value.trim() || undefined,
      phone: els.phone.value.trim() || undefined,
      eventIds: els.eventIds.value.trim() || undefined,
      image: imageDataURL,             // *** IMPORTANT *** ‚Äì backend expects full data URL
      limit: 12,
    };

    if (next && nextToken) payload.pageToken = nextToken;

    console.debug('POST /search', payload);
    const json = await fetchJSON(ENDPOINTS.search, payload);

    // remember for pagination
    lastPayload = payload;
    nextToken = json.nextToken || json.nextContinuationToken || json.next || null;

    if (!next) els.results.innerHTML = '';
    renderResults(json.items || json.results || []);

    setStatus(`‡§Æ‡§ø‡§≤‡•á ${ (json.items?.length || json.results?.length || 0) } ‡§´‡•ã‡§ü‡•ã‡•§`);
    els.more.style.display = nextToken ? 'inline-flex' : 'none';
  }catch(err){
    console.error('search error', err);
    alert('‡§ñ‡•ã‡§ú ‡§Æ‡•á‡§Ç ‡§¶‡§ø‡§ï‡•ç‡§ï‡§§: ' + err.message);
    setStatus('Error');
  }finally{
    els.search.disabled = false;
  }
}

// ---------- Bindings ----------
els.camBtn.addEventListener('click', ()=>{
  if (mediaStream) stopCamera(); else startCamera();
});

els.search.addEventListener('click', ()=> doSearch(false));
els.more.addEventListener('click', ()=> doSearch(true));

// Try auto-start but fail gracefully
if (navigator.mediaDevices?.getUserMedia){
  startCamera().catch(()=>{});
}
</script>
</body>
</html>
