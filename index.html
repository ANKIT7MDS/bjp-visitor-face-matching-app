<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WedMatch – Face Search</title>
  <style>
    :root{
      --brand:#ff6d32;
      --bg:#fafafa;
      --card:#ffffff;
      --muted:#6b7280;
      --ok:#10b981;
      --bad:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#111}
    header{padding:10px 16px;background:#111;color:#fff;position:sticky;top:0;z-index:5}
    header b{color:var(--brand)}
    main{padding:16px;display:grid;grid-template-columns:380px 1fr;gap:16px;align-items:start}
    @media (max-width:980px){main{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 1px 6px rgba(0,0,0,.04)}
    .card h3{margin:0;padding:14px 16px;border-bottom:1px solid #eee}
    .card .content{padding:16px}

    label{font-size:14px;color:#374151;display:block;margin:10px 0 6px}
    input[type="text"]{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;font-size:15px}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{appearance:none;border:none;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn{background:#111;color:#fff}
    .btn.secondary{background:#f3f4f6;color:#111}
    .btn.brand{background:var(--brand);color:#fff}

    .kamera{position:relative;border-radius:12px;overflow:hidden;background:#000;aspect-ratio:4/3}
    video,canvas.kcap{width:100%;height:100%;object-fit:cover;display:block}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;background:#f3f4f6;color:#111}
    .tag.ok{background:#ecfdf5;color:#065f46}
    .tag.bad{background:#fef2f2;color:#991b1b}

    /* results */
    .resultsGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px;padding:12px}
    .photo{border:1px solid #eee;border-radius:12px;background:#fff;overflow:hidden}
    .photo .thumb{width:100%;aspect-ratio:1/1.05;background:#f3f4f6;display:grid;place-items:center;overflow:hidden}
    .photo img{width:100%;display:block}
    .photo .meta{padding:10px 12px;border-top:1px solid #f3f4f6;color:#374151;font-size:13px}
    .pill{padding:2px 8px;border-radius:999px;background:#fff7ed;color:#9a3412;border:1px solid #fed7aa;margin-left:6px}

    .muted{color:var(--muted)}
    .hidden{display:none!important}
    .hr{height:1px;background:#eee;margin:10px 0}
    .center{display:grid;place-items:center}
  </style>
</head>
<body>
  <header>
    <div><b>WedMatch</b> • Face Search</div>
  </header>
  <main>
    <!-- LEFT: form -->
    <section class="card" id="left">
      <h3>खोज</h3>
      <div class="content">
        <div class="row">
          <div>
            <label>नाम (optional)</label>
            <input id="inpName" type="text" placeholder="जैसे: मोहित" />
          </div>
          <div>
            <label>मोबाइल नंबर (optional)</label>
            <input id="inpPhone" type="text" inputmode="numeric" placeholder="10 digits" />
          </div>
        </div>

        <details style="margin-top:8px">
          <summary class="muted">Advanced</summary>
          <label>Event IDs (comma separated, optional)</label>
          <input id="inpEvents" type="text" placeholder="खाली छोड़ें तो ऑटो-पिक" />
        </details>

        <div style="margin-top:12px">
          <label>सेल्फी कैमरा</label>
          <div class="kamera card" id="camWrap">
            <video id="video" playsinline autoplay muted></video>
            <canvas id="snapCanvas" class="kcap hidden"></canvas>
          </div>
          <div class="actions">
            <button class="btn brand" id="btnStartCam">कैमरा चालू</button>
            <button class="btn" id="btnSnap" disabled>सेल्फी लें</button>
            <button class="btn secondary" id="btnRetake" disabled>दोबारा लें</button>
          </div>
        </div>

        <div class="hr"></div>

        <label>या फ़ाइल चुनें</label>
        <input id="filePick" type="file" accept="image/*" />
        <div class="actions">
          <button class="btn" id="btnSearch">Search</button>
          <span id="readyTag" class="tag hidden">सेल्फी तैयार ✓</span>
        </div>

        <details style="margin-top:12px">
          <summary class="muted">Debug</summary>
          <div id="dbg" class="muted" style="font-size:12px;white-space:pre-wrap"></div>
        </details>
      </div>
    </section>

    <!-- RIGHT: results -->
    <section class="card" id="right">
      <h3>परिणाम</h3>
      <div id="resultsWrap">
        <div class="center" style="padding:22px" id="emptyMsg">कोई खोज नहीं चली। पहले सेल्फी लें/अपलोड करें और Search दबाएँ।</div>
        <div id="results" class="resultsGrid hidden"></div>
        <div class="center" style="padding:12px">
          <button id="btnMore" class="btn secondary hidden">और दिखाएँ</button>
        </div>
      </div>
    </section>
  </main>

<script>
(() => {
  // ==== CONFIG ====
  // अपने API गेटवे का BASE URL यहाँ रखें (स्टेज सहित). अगर नहीं बदला तो पिछला काम करता रहेगा।
  const API_BASE = (window.API_BASE) || 'https://oidwg6gcx0.execute-api.ap-south-1.amazonaws.com/PROD2';
  const THUMB_PATH = '/thumb'; // GET /thumb?key=..&w=..&orient=1
  const SEARCH_PATH = '/search';

  // ==== DOM ====
  const els = {
    name: q('#inpName'), phone: q('#inpPhone'), events: q('#inpEvents'),
    video: q('#video'), canvas: q('#snapCanvas'), startCam: q('#btnStartCam'),
    snap: q('#btnSnap'), retake: q('#btnRetake'), file: q('#filePick'),
    search: q('#btnSearch'), ready: q('#readyTag'),
    resGrid: q('#results'), emptyMsg: q('#emptyMsg'), more: q('#btnMore'),
    dbg: q('#dbg'),
  };

  // state
  const S = { stream: null, photoDataUrl: null, results: [], nextToken: null };

  // ==== Helpers ====
  function q(s, r=document){ return r.querySelector(s); }
  const sleep = ms => new Promise(r => setTimeout(r, ms));
  function log(...a){ console.log(...a); els.dbg.textContent += a.map(x => typeof x==='string'?x:JSON.stringify(x)).join(' ')+'\n'; }

  async function fetchJSON(url, opts={}){
    const res = await fetch(url, Object.assign({ headers:{'Content-Type':'application/json'} }, opts));
    if(!res.ok){
      const txt = await res.text().catch(()=>'' );
      throw new Error(`HTTP ${res.status}: ${txt}`);
    }
    return res.json();
  }

  function dataURLFromVideo() {
    const v = els.video, c = els.canvas;
    const w = v.videoWidth || 1280, h = v.videoHeight || 720;
    c.width = w; c.height = h;
    const ctx = c.getContext('2d');
    ctx.drawImage(v,0,0,w,h);
    return c.toDataURL('image/jpeg', 0.9);
  }

  function showCanvasPreview(dUrl){
    els.canvas.classList.remove('hidden');
    els.video.classList.add('hidden');
    // draw was already done; when using file we need to put image on canvas
  }

  async function startCamera(){
    try{
      if(S.stream){ return; }
      const constraints = { video: { facingMode: { ideal: 'user' }, width: { ideal: 1280 }, height:{ ideal: 720 } }, audio:false };
      const st = await navigator.mediaDevices.getUserMedia(constraints);
      S.stream = st; els.video.srcObject = st;
      els.snap.disabled = false; els.retake.disabled = true;
      log('camera started');
    }catch(err){
      alert('Camera चालू नहीं हो सका: '+ err.message + '\nआप file upload से भी खोज चला सकते हैं।');
      log('camera error', err);
    }
  }

  function stopCamera(){
    if(S.stream){ S.stream.getTracks().forEach(t=>t.stop()); S.stream=null; }
  }

  function setReady(on){ els.ready.classList.toggle('hidden', !on); }

  // Build thumb URL from S3 key
  function thumbURL(key){
    const enc = encodeURIComponent(key);
    return `${API_BASE}${THUMB_PATH}?key=${enc}&w=512&orient=1`;
  }

  function paintFileToCanvas(file){
    return new Promise((resolve,reject)=>{
      const r = new FileReader();
      r.onload = () => {
        const img = new Image();
        img.onload = () => {
          els.canvas.width = img.width; els.canvas.height = img.height;
          els.canvas.getContext('2d').drawImage(img,0,0);
          els.canvas.classList.remove('hidden');
          els.video.classList.add('hidden');
          resolve();
        };
        img.onerror = reject;
        img.src = r.result;
      };
      r.onerror = reject; r.readAsDataURL(file);
    });
  }

  // ==== UI wiring ====
  els.startCam.addEventListener('click', async () => { await startCamera(); });
  els.snap.addEventListener('click', () => {
    if(!S.stream){ return; }
    S.photoDataUrl = dataURLFromVideo();
    showCanvasPreview(S.photoDataUrl);
    setReady(true); els.retake.disabled = false;
  });

  els.retake.addEventListener('click', () => {
    if(S.stream){ els.video.classList.remove('hidden'); els.canvas.classList.add('hidden'); }
    setReady(false); S.photoDataUrl = null; els.retake.disabled = true;
  });

  els.file.addEventListener('change', async (e) => {
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    await paintFileToCanvas(f);
    S.photoDataUrl = els.canvas.toDataURL('image/jpeg',0.92);
    setReady(true); els.retake.disabled = false;
  });

  els.search.addEventListener('click', async () => {
    try{
      els.search.disabled = true; els.more.classList.add('hidden');
      await doSearch(true);
    }catch(err){
      alert('खोज में दिक्कत: '+err.message);
      log('search error', err);
    }finally{
      els.search.disabled = false;
    }
  });

  els.more.addEventListener('click', async () => {
    try{ els.more.disabled = true; await doSearch(false); } finally { els.more.disabled=false; }
  });

  async function doSearch(reset){
    if(!S.photoDataUrl){ alert('पहले सेल्फी लें या फ़ाइल चुनें'); return; }

    if(reset){ S.results=[]; S.nextToken=null; renderResults(); }

    const payload = {
      name: els.name.value.trim() || undefined,
      phone: els.phone.value.trim() || undefined,
      eventIds: (els.events.value||'').split(',').map(s=>s.trim()).filter(Boolean),
      photo: S.photoDataUrl, // data URL
      limit: 10,
      nextToken: S.nextToken || undefined,
    };

    log('POST', SEARCH_PATH, payload);
    const json = await fetchJSON(`${API_BASE}${SEARCH_PATH}`, { method:'POST', body: JSON.stringify(payload)});

    const { items = [], nextToken = null } = json;
    S.results.push(...items); S.nextToken = nextToken;
    renderResults();

    els.more.classList.toggle('hidden', !S.nextToken);
  }

  function renderResults(){
    const wrap = els.resGrid; wrap.innerHTML='';
    if(!S.results.length){ els.emptyMsg.classList.remove('hidden'); wrap.classList.add('hidden'); return; }
    els.emptyMsg.classList.add('hidden'); wrap.classList.remove('hidden');

    for(const it of S.results){
      // it { key / photoId, eventId, score, etag }
      const key = it.key || it.photoKey || it.photoId || it.id || '';
      const score = it.score!=null ? Math.round(it.score*100) : (it.match||'~100%');
      const idTxt = it.photoId || it.id || key.split('/').pop();

      const div = document.createElement('div');
      div.className='photo';
      div.innerHTML = `
        <div class="thumb"><img loading="lazy" referrerpolicy="no-referrer" src="${thumbURL(key)}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'480\' height=\'480\'%3E%3Crect width=\'100%25\' height=\'100%25\' fill=\'%23f3f4f6\'/%3E%3C/svg%3E'" /></div>
        <div class="meta">
          <div class="muted">ID: <span title="${key}">${idTxt}</span> <span class="pill">~${score}% match</span></div>
        </div>`;
      wrap.appendChild(div);
    }
  }

  // Auto start camera for https origins
  if(location.protocol === 'https:' && navigator.mediaDevices){
    // Small delay so autoplay policy settles
    sleep(400).then(startCamera);
  }
})();
</script>
</body>
</html>
