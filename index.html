<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"
  />
  <title>खोज (Debug Edition)</title>
  <style>
    :root{
      --bg:#0f1320;--card:#151b2d;--muted:#8aa0c5;--text:#e8eeff;--brand:#5b8cff;
      --ok:#39d98a;--warn:#f7b955;--err:#ff6b6b;--chip:#2a3454;--chip2:#1b223b;
      --border:#24304b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    .container{max-width:1220px;margin:auto;padding:24px 20px 120px}
    h1{margin:0 0 18px;font-size:28px;display:flex;gap:12px;align-items:center}
    .badge{
      display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;
      background:var(--chip);color:#dbe6ff;border:1px solid var(--border);font-size:12px
    }
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{
      background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px
    }
    label{display:block;font-size:12px;color:var(--muted);margin:2px 0 6px}
    input,textarea,select{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);
      background:#0e1424;color:var(--text);outline:none
    }
    input::placeholder{color:#6f85ad}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{
      padding:10px 14px;border-radius:10px;border:1px solid var(--border);
      background:var(--chip);color:#dbe6ff;cursor:pointer
    }
    .btn.primary{background:var(--brand);border-color:#4b78e6;color:white}
    .btn.ghost{background:var(--chip2)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .toolbar{display:flex;gap:10px;align-items:center;margin-bottom:14px;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .grid{
      display:grid;grid-template-columns:repeat(4,minmax(0,1fr));
      gap:14px;margin-top:14px
    }
    @media(max-width:1100px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:840px){.row{grid-template-columns:1fr}.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:560px){.grid{grid-template-columns:1fr}}
    .photo{
      background:#0c1122;border:1px solid var(--border);border-radius:12px;overflow:hidden;
      display:flex;flex-direction:column
    }
    .ph-img{
      aspect-ratio: 1 / 1;display:block;width:100%;object-fit:cover;background:#0b1020;
      background-image:linear-gradient(120deg,#0b1020,#0a0f1c)
    }
    .ph-body{padding:12px;border-top:1px solid var(--border)}
    .chips{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .chip{
      background:var(--chip2);border:1px solid var(--border);padding:4px 8px;border-radius:999px;
      color:#cfe1ff;font-size:12px
    }
    .chip.ok{background:#0e2b20;border-color:#124d36;color:#9af0c4}
    .chip.err{background:#2b0e12;border-color:#5e1f26;color:#ffb3b3}
    .meta{font-size:12px;color:#b7c8ef;word-break:break-all}
    .ph-actions{display:flex;gap:8px;margin-top:10px}
    .btn-sm{padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:#1a2340;color:#e5eeff;font-size:12px;cursor:pointer}
    .btn-sm:hover{filter:brightness(1.08)}
    .debug{
      background:#0a0f1e;border:1px solid var(--border);border-radius:12px;
      max-height:320px;overflow:auto;padding:10px 12px;font:12px/1.45 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      white-space:pre-wrap;color:#d8e6ff
    }
    .kbd{padding:2px 6px;border-radius:6px;border:1px solid var(--border);background:#0f162b;color:#cfe1ff}
    .help{font-size:12px;color:#8aa0c5;margin-top:6px}
    .noimg{display:grid;place-content:center;min-height:180px;color:#889ac0}
  </style>
</head>
<body>
  <div class="container">
    <h1>
      खोज <span class="muted">(Debug Edition)</span>
      <span class="badge" id="stageBadge">Stage: –</span>
      <span class="badge" id="apiBadge">API: –</span>
      <button class="btn ghost" id="btnChangeApi">Change API</button>
      <button class="btn ghost" id="btnClearCache">Clear cache</button>
    </h1>

    <div class="toolbar">
      <button class="btn" id="btnShowLogs">Debug logs</button>
      <span class="help">कोई समस्या हो तो <span class="kbd">Debug logs</span> खोलें — हर request/response का detail दिखेगा।</span>
    </div>
    <div class="debug" id="debug" hidden></div>

    <div class="card" style="margin-bottom:16px">
      <div class="row">
        <div>
          <label>नाम (अनिवार्य)</label>
          <input id="inpName" placeholder="उदा. ANKIT / अंकित" />
        </div>
        <div>
          <label>मोबाइल नंबर (अनिवार्य)</label>
          <input id="inpPhone" placeholder="उदा. 9893074891" />
        </div>
        <div>
          <label>Event IDs (comma-separated, optional)</label>
          <input id="inpEventIds" placeholder="उदा. EVT_2025_08_12" value="EVT_2025_08_12" />
        </div>
        <div>
          <label>Limit (server)</label>
          <input id="inpLimit" type="number" value="50" />
        </div>
      </div>
      <div class="actions">
        <button class="btn primary" id="btnSearch">खोजें</button>
        <button class="btn" id="btnClear">फॉर्म साफ़</button>
      </div>
      <div class="help">पहले 10 फ़ोटो दिखेंगी, “open” पर click से full-size thumb/इमेज खुलेगी।</div>
    </div>

    <div class="muted" id="resultTitle">मिले 0 फोटो।</div>
    <div class="grid" id="grid"></div>
  </div>

  <script>
    /***********************
     * CONFIG
     ***********************/
    const DEFAULT_API = 'https://oidwg6gcx0.execute-api.ap-south-1.amazonaws.com/PROD2';
    const LS_API_KEY = 'wm.apiBase.v1';

    const state = {
      apiBase: localStorage.getItem(LS_API_KEY) || DEFAULT_API,
      results: [],
      loading: false
    };

    /***********************
     * DOM refs
     ***********************/
    const debugEl = document.getElementById('debug');
    const apiBadge = document.getElementById('apiBadge');
    const stageBadge = document.getElementById('stageBadge');
    const btnShowLogs = document.getElementById('btnShowLogs');
    const btnChangeApi = document.getElementById('btnChangeApi');
    const btnClearCache = document.getElementById('btnClearCache');

    const inpName = document.getElementById('inpName');
    const inpPhone = document.getElementById('inpPhone');
    const inpEventIds = document.getElementById('inpEventIds');
    const inpLimit = document.getElementById('inpLimit');

    const btnSearch = document.getElementById('btnSearch');
    const btnClear = document.getElementById('btnClear');
    const grid = document.getElementById('grid');
    const resultTitle = document.getElementById('resultTitle');

    /***********************
     * Helpers: logging
     ***********************/
    function setBadges() {
      apiBadge.textContent = 'API: ' + state.apiBase;
      try {
        const p = new URL(state.apiBase);
        const stage = p.pathname.split('/').filter(Boolean)[0] || '—';
        stageBadge.textContent = 'Stage: ' + stage.toUpperCase();
      } catch {
        stageBadge.textContent = 'Stage: —';
      }
    }
    setBadges();

    function log(level, obj) {
      const line = JSON.stringify({
        time: new Date().toISOString(),
        level,
        obj
      });
      console[level === 'error' ? 'error' : 'log'](line);
      const at = document.createElement('div');
      at.textContent = line;
      debugEl.appendChild(at);
      if (debugEl.childNodes.length > 2000) {
        debugEl.removeChild(debugEl.firstChild);
      }
    }

    function showLogsToggle(){
      debugEl.hidden = !debugEl.hidden;
      btnShowLogs.textContent = debugEl.hidden ? 'Debug logs' : 'Hide logs';
    }

    btnShowLogs.onclick = showLogsToggle;

    btnChangeApi.onclick = () => {
      const v = prompt('Enter API base (e.g. https://<apiId>.execute-api.ap-south-1.amazonaws.com/PROD2)', state.apiBase);
      if (!v) return;
      try {
        new URL(v); // validate
        state.apiBase = v;
        localStorage.setItem(LS_API_KEY, v);
        setBadges();
        alert('Saved!');
      } catch {
        alert('Invalid URL');
      }
    };

    btnClearCache.onclick = () => {
      if (confirm('Clear localStorage API and image cache?')) {
        localStorage.removeItem(LS_API_KEY);
        caches?.keys?.().then(keys => keys.forEach(k => caches.delete(k)));
        alert('Cleared. Reloading…');
        location.reload();
      }
    };

    /***********************
     * API helpers
     ***********************/
    const API = () => state.apiBase.replace(/\/+$/,''); // trim trailing slash

    async function jpost(path, body){
      const url = API() + path;
      const payload = {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)};
      log('info', {event:'request', url, method:'POST', headers:payload.headers, body:payload.body});
      try{
        const res = await fetch(url, payload);
        const text = await res.text();
        let data = null;
        try { data = text ? JSON.parse(text) : {}; } catch { data = {raw:text}; }
        log('info', {event:'response', url, status:res.status, took_ms:'n/a', headers: Object.fromEntries(res.headers.entries()), raw:text?.slice?.(0,2000)});
        if(!res.ok) throw new Error(data?.message || ('HTTP '+res.status));
        return data;
      }catch(err){
        log('error', {event:'fetch-error', url, message: String(err)});
        throw err;
      }
    }

    /***********************
     * URL builders
     ***********************/
    const IMAGE_EXT_RE = /\.(jpe?g|png|webp|gif)$/i;
    const withExt = (k) => IMAGE_EXT_RE.test(k) ? k : `${k}.jpg`;

    function thumbURL(evId, key, w=256){
      const k = withExt(key || '');
      const q = new URLSearchParams({eventId: evId || '', key: k, w: String(w), orient:'1'});
      return `${API()}/thumb?${q.toString()}`;
    }
    function fullURL(evId, key){
      const k = withExt(key || '');
      const q = new URLSearchParams({eventId: evId || '', key: k});
      return `${API()}/download?${q.toString()}`;
    }

    /***********************
     * UI actions
     ***********************/
    btnClear.onclick = () => {
      inpName.value = '';
      inpPhone.value = '';
      // eventIds रखना चाहें तो रखें; यहाँ नहीं छू रहे
      inpLimit.value = '50';
      grid.innerHTML = '';
      resultTitle.textContent = 'मिले 0 फोटो।';
    };

    btnSearch.onclick = doSearch;

    async function doSearch(){
      if(state.loading) return;
      const name = (inpName.value || '').trim();
      const phone = (inpPhone.value || '').trim();
      const limit = Number(inpLimit.value || '50') || 50;
      const eventIds = (inpEventIds.value || '')
        .split(',')
        .map(s => s.trim())
        .filter(Boolean);

      if(!name && !phone){
        alert('कम से कम नाम या मोबाइल नंबर भरिए।');
        return;
      }

      state.loading = true;
      btnSearch.disabled = true;
      try{
        const payload = {name, phone, limit, eventIds};
        const data = await jpost('/search', payload);
        const results = Array.isArray(data?.results) ? data.results : [];
        state.results = results;
        resultTitle.textContent = `मिले ${data?.count ?? results.length} फोटो।`;
        renderGrid(results);
      }catch(err){
        alert('खोज में दिक्कत: ' + String(err?.message || err));
      }finally{
        state.loading = false;
        btnSearch.disabled = false;
      }
    }

    /***********************
     * Grid rendering
     ***********************/
    function renderGrid(list){
      grid.innerHTML = '';
      if(!list?.length){
        grid.innerHTML = '<div class="card noimg">कोई परिणाम नहीं।</div>';
        return;
      }
      const frag = document.createDocumentFragment();
      list.forEach((r, i) => frag.appendChild(makeCard(r, i)));
      grid.appendChild(frag);
      setupLazy();
    }

    function makeCard(r, idx){
      const id  = r.id || r.key || '';
      const key = r.key || r.id || '';
      const ev  = r.eventId || r.event || '';
      const score = r.score != null ? Math.round(r.score*100) : null;

      const wrap = document.createElement('div');
      wrap.className = 'photo';

      const img = document.createElement('img');
      img.className = 'ph-img';
      img.alt = key;
      img.dataset.src = thumbURL(ev, key, 320);
      img.onerror = () => {
        // fallback – small width
        img.src = thumbURL(ev, key, 160) + '&t=' + Date.now();
      };
      wrap.appendChild(img);

      const body = document.createElement('div');
      body.className = 'ph-body';

      const chips = document.createElement('div');
      chips.className = 'chips';
      if(score!=null){
        const ch = document.createElement('span');
        ch.className = 'chip ok';
        ch.textContent = `~${score}%`;
        chips.appendChild(ch);
      }
      const ch2 = document.createElement('span');
      ch2.className = 'chip';
      ch2.textContent = 'match';
      chips.appendChild(ch2);
      body.appendChild(chips);

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.innerHTML =
        `ID: <b>${(id || key).replaceAll('<','&lt;')}</b><br/>` +
        `Event: <b>${ev || '—'}</b>`;
      body.appendChild(meta);

      const act = document.createElement('div');
      act.className = 'ph-actions';
      const bOpen = document.createElement('button');
      bOpen.className = 'btn-sm';
      bOpen.textContent = 'open';
      bOpen.onclick = () => window.open(fullURL(ev, key), '_blank');
      act.appendChild(bOpen);

      const bCopy = document.createElement('button');
      bCopy.className = 'btn-sm';
      bCopy.textContent = 'copy id';
      bCopy.onclick = async () => {
        try { await navigator.clipboard.writeText(id || key || ''); bCopy.textContent = 'copied!'; setTimeout(()=>bCopy.textContent='copy id',1200);} catch {}
      };
      act.appendChild(bCopy);

      body.appendChild(act);
      wrap.appendChild(body);
      return wrap;
    }

    /***********************
     * Lazy loading
     ***********************/
    let io;
    function setupLazy(){
      io?.disconnect?.();
      io = new IntersectionObserver((entries)=>{
        for(const e of entries){
          if(e.isIntersecting){
            const img = e.target;
            if(img.dataset.src && img.dataset.src !== img.src){
              img.src = img.dataset.src;
              delete img.dataset.src;
            }
            io.unobserve(img);
          }
        }
      },{rootMargin:'200px'});
      document.querySelectorAll('img.ph-img').forEach(el=>io.observe(el));
    }

    // initial fill
    (function init(){
      log('info', {event:'app-started', api: state.apiBase});
    })();
  </script>
</body>
</html>
