<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>खोज (Debug Edition)</title>
  <style>
    :root{
      --bg:#0b0f15; --panel:#101722; --muted:#7b8aa3; --text:#e6eefc; --accent:#4cc9f0;
      --chip:#1b2330; --ok:#24d18c; --warn:#e7b416; --err:#ef476f; --card:#0f1622;
    }
    *{box-sizing:border-box}
    body{margin:0; background:var(--bg); color:var(--text); font:14px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,Arial}
    a{color:var(--accent); text-decoration:none}
    h1{margin:16px 0 8px}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .bar{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .badge{background:var(--chip); color:var(--muted); padding:6px 10px;border-radius:999px}
    .muted{color:var(--muted)}
    .panel{background:var(--panel); border:1px solid #1f2a3b; border-radius:12px; padding:12px}
    .row{display:grid;grid-template-columns:repeat(12,1fr); gap:12px}
    .col-6{grid-column:span 6}
    .col-12{grid-column:span 12}
    label{display:block;margin:6px 0 6px 2px;color:#b8c2d9;font-size:12px}
    input,textarea,select{
      width:100%; background:#0d1320; color:var(--text); border:1px solid #1f2a3b;
      border-radius:10px; padding:10px; outline:none;
    }
    input::placeholder{color:#58647a}
    .btn{
      background:#18314a; color:#e6eefc; border:1px solid #23405e; padding:10px 14px;
      border-radius:10px; cursor:pointer; transition:.12s; user-select:none;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{background:linear-gradient(180deg,#275c8a,#21476c); border-color:#2b5a88}
    .btn.warn{background:#553b0c;border-color:#7a540f}
    .btn.ghost{background:transparent}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:12px}
    .card{background:var(--card); border:1px solid #1d2737; border-radius:14px; overflow:hidden; display:flex; flex-direction:column}
    .thumb{width:100%; height:180px; object-fit:cover; background:#0b1220}
    .card-body{padding:10px; display:flex; flex-direction:column; gap:6px}
    .pill{display:inline-flex;gap:6px; align-items:center; padding:2px 8px; border-radius:999px; background:#1b2232; color:#a8b2c6; font-size:12px}
    .pill.ok{background:#0f2a22;color:#8fe8c0}
    .pill.warn{background:#2c2811;color:#ffe08a}
    .pill.err{background:#2a1218;color:#ff9fb2}
    .actions{display:flex; gap:8px; margin-top:auto}
    .small{font-size:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .log{white-space:pre-wrap;background:#0a101a;border:1px solid #162134;border-radius:12px;padding:10px;max-height:280px;overflow:auto}
    .tag{color:#9fb3c8;background:#0f1a29;border:1px solid #213147;padding:2px 6px;border-radius:6px}
    .divider{height:1px;background:#1f2a3b;margin:10px 0}
    .flex{display:flex;gap:10px;align-items:center}
    .right{margin-left:auto}
    .mt8{margin-top:8px}
    .mt12{margin-top:12px}
    .mt16{margin-top:16px}
    .mb8{margin-bottom:8px}
    .nowrap{white-space:nowrap}
    @media(max-width:900px){.col-6{grid-column:span 12}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <h1>खोज <span class="muted">(Debug Edition)</span></h1>
      <span class="badge">Stage: <strong id="stage">PROD2</strong></span>
      <span class="badge nowrap">API:
        <span id="apiShow" class="muted mono" style="margin-left:6px"></span>
      </span>
      <button id="btnEditApi" class="btn ghost">Change API</button>
      <button id="btnClearCache" class="btn ghost">Clear cache</button>
      <span class="right"></span>
      <a class="btn ghost" href="#" id="btnToggleDebug">Debug logs</a>
    </div>

    <div id="apiEditPanel" class="panel mt8" style="display:none">
      <div class="row">
        <div class="col-12">
          <label>API Base (e.g., https://oidwg6gcx0.execute-api.ap-south-1.amazonaws.com/PROD2)</label>
          <input id="tbApiBase" placeholder="https://.../PROD2"/>
          <div class="mt8 flex">
            <button id="btnSaveApi" class="btn primary">Save</button>
            <button id="btnCancelApi" class="btn">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <div class="panel mt12">
      <div class="row">
        <div class="col-6">
          <label>नाम (अनिवार्य)</label>
          <input id="tbName" placeholder="जैसे: अंकित सोनी" />
        </div>
        <div class="col-6">
          <label>मोबाइल नंबर (अनिवार्य)</label>
          <input id="tbPhone" placeholder="जैसे: 9893074891" />
        </div>
        <div class="col-6">
          <label>Event IDs (comma-separated, optional)</label>
          <input id="tbEvents" placeholder="उदा. EVT_2025_08_12, demo-20" />
        </div>
        <div class="col-6">
          <label>Limit (server)</label>
          <input id="tbLimit" type="number" min="1" max="200" value="50" />
        </div>
        <div class="col-12">
          <div class="flex mt8">
            <button id="btnSearch" class="btn primary">खोजें</button>
            <button id="btnClear" class="btn">फॉर्म साफ़</button>
            <span class="muted">पहले 10 फोटो दिखेंगे, “open” पर click से full-size thumb खुलेगा</span>
          </div>
        </div>
      </div>
    </div>

    <div id="summary" class="mt8 muted small">मिले <b id="count">0</b> फोटो।</div>

    <div id="results" class="grid mt8"></div>

    <div id="debugPanel" class="panel mt12" style="display:none">
      <div class="flex">
        <strong>Debug logs</strong>
        <span class="right"></span>
        <button id="btnCopyLogs" class="btn">Copy</button>
        <button id="btnClearLogs" class="btn warn">Clear</button>
      </div>
      <div id="logs" class="log mt8 mono"></div>
    </div>
  </div>

  <script>
  // ========= Config =========
  const API_BASE_DEFAULT = 'https://oidwg6gcx0.execute-api.ap-south-1.amazonaws.com/PROD2';

  const LS_KEY = 'wm_api_base';
  const API_BASE = getApiBase();
  const SEARCH_URL = `${API_BASE}/search`;
  const THUMB_URL = `${API_BASE}/thumb`;

  // ========= UI refs =========
  const $ = sel => document.querySelector(sel);
  const logsEl   = $('#logs');
  const countEl  = $('#count');
  const resEl    = $('#results');
  const apiShow  = $('#apiShow');
  const stageEl  = $('#stage');

  apiShow.textContent = API_BASE;

  // ========= Debug logger =========
  function nowISO(){ return new Date().toISOString(); }
  function log(level, msg, obj){
    const line = `[${nowISO()}] [${level}] ${msg}` + (obj?`\n${safeJson(obj)}`:'');
    logsEl.textContent += (logsEl.textContent ? '\n' : '') + line;
    logsEl.scrollTop = logsEl.scrollHeight;
    console[level==='error'?'error':'log'](line);
  }
  function safeJson(x){
    try{ return JSON.stringify(x, null, 2); }catch{ return String(x) }
  }

  function getApiBase(){
    const saved = localStorage.getItem(LS_KEY);
    return saved && saved.startsWith('http') ? saved : API_BASE_DEFAULT;
  }
  function setApiBase(v){
    localStorage.setItem(LS_KEY, v);
    location.reload();
  }

  // ========= HTTP helper =========
  async function fetchJSON(url, opts={}){
    log('info', 'request', { url, method: opts.method||'GET', headers: opts.headers, body: opts.body });
    let resp;
    try{
      resp = await fetch(url, {
        mode: 'cors',            // CORS enabled
        credentials: 'omit',     // no cookies
        cache: 'no-store',
        ...opts
      });
    }catch(e){
      // network/preflight block
      log('error', 'preflight-error', { error: String(e) });
      alert(`Preflight failed: ${e.message || e}`);
      throw e;
    }

    const text = await resp.text();
    const contentType = (resp.headers.get('content-type')||'').toLowerCase();
    let data;
    if(contentType.includes('application/json')){
      try{ data = JSON.parse(text) }catch{ data = { raw:text } }
    }else{
      data = { raw:text };
    }

    log('info', 'response', { url, status: resp.status, took_ms: null, headers: Object.fromEntries(resp.headers.entries()), raw: text.slice(0, 3000) });

    if(!resp.ok){
      const msg = data && data.message ? data.message : `HTTP ${resp.status}`;
      alert(`खोज में दिक्कत: ${msg}`);
      throw new Error(msg);
    }
    return data;
  }

  async function jpost(url, payload){
    return fetchJSON(url, {
      method:'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload||{})
    });
  }

  // ========= Thumbnail URL builder =========
  function makeThumbUrl({ eventId, key, width=720, orient=1 }){
    const p = new URLSearchParams({
      eventId,
      key,
      w: String(width),
      orient: String(orient),
      failOn: 'none',     // << important: string value
    });
    return `${THUMB_URL}?${p.toString()}`;
  }

  // ========= Rendering =========
  function pct(score){
    // server may send -1..1 OR 0..1; just show absolute percentage
    if(score === null || score === undefined) return '~';
    const v = Math.abs(Number(score));
    if(!isFinite(v)) return '~';
    return (v<=1 ? (v*100) : v).toFixed(0)+'%';
  }

  function renderResults(items){
    resEl.innerHTML = '';
    if(!Array.isArray(items) || !items.length){
      countEl.textContent = '0';
      return;
    }
    countEl.textContent = String(items.length);

    items.slice(0, 50).forEach(it=>{
      const id      = it.id || it.photoId || it.key || '-';
      const key     = it.key || it.photoKey || '';
      const eventId = it.eventId || it.event || '';
      const score   = it.score;
      const percent = pct(score);

      const card   = document.createElement('div');
      card.className = 'card';

      // image
      const img = document.createElement('img');
      img.className = 'thumb';
      img.alt = 'thumbnail';
      if(eventId && key){
        img.src = makeThumbUrl({ eventId, key, width: 480, orient: 1 });
      }else{
        img.alt = 'No preview';
      }
      img.onerror = ()=>{ img.src=''; img.alt='No preview'; };

      // body
      const body = document.createElement('div');
      body.className = 'card-body mono';

      const line1 = document.createElement('div');
      line1.innerHTML = `<span class="pill ok">~${percent}</span> <span class="pill">match</span>`;
      const line2 = document.createElement('div');
      line2.className = 'small';
      line2.innerHTML = `<b>ID:</b> ${escapeHtml(id)}`;
      const line3 = document.createElement('div');
      line3.className = 'small';
      line3.innerHTML = `<b>Event:</b> ${escapeHtml(eventId)}`;

      const actions = document.createElement('div');
      actions.className = 'actions';

      const btnOpen = document.createElement('button');
      btnOpen.className = 'btn';
      btnOpen.textContent = 'open';
      btnOpen.onclick = ()=>{
        if(eventId && key){
          const u = makeThumbUrl({ eventId, key, width: 1280, orient: 1 });
          window.open(u, '_blank','noopener');
        }
      };

      const btnCopy = document.createElement('button');
      btnCopy.className = 'btn';
      btnCopy.textContent = 'copy id';
      btnCopy.onclick = ()=>{
        navigator.clipboard.writeText(id);
      };

      actions.append(btnOpen, btnCopy);
      body.append(line1, line2, line3, actions);

      card.append(img, body);
      resEl.append(card);
    });
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // ========= Search =========
  async function doSearch(){
    const name  = $('#tbName').value.trim();
    const phone = $('#tbPhone').value.trim();
    const limit = Math.max(1, Math.min(200, Number($('#tbLimit').value||50)));
    const events = ($('#tbEvents').value||'').split(',').map(s=>s.trim()).filter(Boolean);

    if(!name || !phone){
      alert('कृपया नाम और मोबाइल नंबर भरें');
      return;
    }

    const payload = { name, phone, limit };
    if(events.length) payload.eventIds = events;

    const data = await jpost(SEARCH_URL, payload);
    // server body format: { count, results }
    const items = data.results || [];
    renderResults(items);
  }

  // ========= Handlers =========
  $('#btnSearch').onclick = doSearch;
  $('#btnClear').onclick = ()=>{
    $('#tbName').value = '';
    $('#tbPhone').value = '';
    $('#tbEvents').value = '';
    $('#tbLimit').value = 50;
    resEl.innerHTML = ''; countEl.textContent = '0';
  };

  // Debug panel
  const debugPanel = $('#debugPanel');
  $('#btnToggleDebug').onclick = ()=>{
    debugPanel.style.display = debugPanel.style.display==='none' ? '' : 'none';
  };
  $('#btnCopyLogs').onclick = ()=>{
    navigator.clipboard.writeText(logsEl.textContent||'');
  };
  $('#btnClearLogs').onclick = ()=>{
    logsEl.textContent = '';
  };

  // API Edit
  const apiEdit = $('#apiEditPanel');
  $('#btnEditApi').onclick = ()=>{
    $('#tbApiBase').value = API_BASE;
    apiEdit.style.display = '';
  };
  $('#btnSaveApi').onclick = ()=>{
    const v = $('#tbApiBase').value.trim();
    if(!v.startsWith('http')){ alert('Invalid URL'); return; }
    setApiBase(v);
  };
  $('#btnCancelApi').onclick = ()=>{ apiEdit.style.display = 'none'; };

  $('#btnClearCache').onclick = ()=>{
    localStorage.removeItem(LS_KEY);
    location.reload();
  };

  // ========= Startup =========
  log('info','camera started'); // (placeholder log to match your earlier UI)

  // Fill from querystring for quick test (?name=..&phone=..&event=EVT_2025_08_12)
  const qs = new URLSearchParams(location.search);
  if(qs.get('name'))  $('#tbName').value  = qs.get('name');
  if(qs.get('phone')) $('#tbPhone').value = qs.get('phone');
  if(qs.get('event')) $('#tbEvents').value= qs.get('event');

  </script>
</body>
</html>
