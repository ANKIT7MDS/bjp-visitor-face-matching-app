<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>खोज – Debug Edition</title>
  <style>
    :root{
      --bg:#0f1216; --panel:#151a21; --muted:#9aa4b2; --text:#e6edf3; --brand:#2ecc71; --accent:#7aa2f7; --danger:#ff6b6b;
      --card:#0f1319; --chip:#223048; --chip2:#1a2333;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    a{color:var(--accent)}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    h1{font-size:28px;margin:0 0 10px}
    small.mono{font:12px/1.2 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;color:var(--muted)}

    .toolbar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:8px 0 16px}
    .chip{background:var(--chip);color:#cfe0ff;border:1px solid #2b3a55;border-radius:999px;padding:6px 12px}
    .chip.good{background:#1e2a22;color:#b6f7c8;border-color:#2a3e30}
    .btn{background:#1f2937;color:#d8e3f0;border:1px solid #334155;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn:hover{filter:brightness(1.08)}
    .btn.sm{padding:6px 10px;border-radius:8px}
    .btn.ghost{background:transparent}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    .card{background:var(--panel);border:1px solid #1f2836;border-radius:14px;padding:16px}

    .grid{--w:260px;display:grid;grid-template-columns:repeat(auto-fill,minmax(var(--w),1fr));gap:18px;margin-top:14px}
    .result{background:var(--card);border:1px solid #1b2433;border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
    .thumb{aspect-ratio:4/3;background:linear-gradient(180deg,#11161e,#0b0f15);display:grid;place-items:center;color:#7b8aa0;font-size:13px}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .meta{padding:10px 12px;border-top:1px solid #162033}
    .pill{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;background:var(--chip2);border:1px solid #2a3b55;color:#cbd8f1}
    .row2{display:flex;justify-content:space-between;gap:10px;margin-top:10px}
    .row2 .btn{flex:1}

    .form{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .form .full{grid-column:1 / -1}
    label{display:block;font-weight:600;color:#b9c5d8;margin-bottom:6px}
    input[type=text], input[type=number]{width:100%;padding:12px;border-radius:10px;border:1px solid #273347;background:#111722;color:#eaf2ff}

    .switch{display:inline-flex;align-items:center;gap:8px}
    .switch input{accent-color:#2ecc71}

    .logs{max-height:260px;overflow:auto;background:#0e141d;border:1px solid #1e293b;border-radius:12px;padding:10px}
    .logline{display:flex;gap:8px;border-bottom:1px dashed #1f2a3b;padding:6px 0}
    .logline:last-child{border-bottom:0}
    .t{color:#8aa3bf;font:12px/1.2 ui-monospace,Consolas,monospace}
    .lvl{font:11px/1.2 ui-monospace;min-width:42px;text-align:center;border-radius:6px;padding:2px 6px}
    .lvl.info{background:#152332;color:#98c1ff}
    .lvl.warn{background:#332a15;color:#ffd98e}
    .lvl.error{background:#331a1a;color:#ffb3b3}

    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>खोज <small class="muted">(Debug Edition)</small></h1>

    <div class="toolbar">
      <span class="chip good" id="stageChip">Stage: PROD2</span>
      <span class="chip" id="apiChip">API: <span id="apiLabel"></span></span>
      <button class="btn sm" id="btnChangeApi">Change API</button>
      <button class="btn sm ghost" id="btnClearCache">Clear cache</button>
      <button class="btn sm" id="btnToggleLogs">Debug logs</button>
    </div>

    <div class="card">
      <div class="form">
        <div>
          <label>नाम (optional)</label>
          <input id="name" type="text" placeholder="ANKIT" />
        </div>
        <div>
          <label>मोबाइल नंबर (optional)</label>
          <input id="phone" type="text" placeholder="9893074891" />
        </div>
        <div class="full">
          <label>Event IDs (comma-separated, optional)</label>
          <input id="eventIds" type="text" placeholder="EVT_2025_08_12, EVT_2025_08_13" />
        </div>
        <div>
          <label>Limit (server)</label>
          <input id="limit" type="number" min="1" max="200" value="50" />
        </div>
        <div style="display:flex;align-items:flex-end;gap:10px">
          <button class="btn" id="btnSearch">खोजें</button>
          <button class="btn ghost" id="btnClear">फॉर्म साफ</button>
        </div>
        <div class="full" style="display:flex;gap:18px;align-items:center;margin-top:6px">
          <label class="switch"><input id="optThumbs" type="checkbox" checked /> Thumbnails दिखाएँ</label>
          <label class="switch"><input id="optRequireSelfie" type="checkbox" /> Selfie आवश्यक</label>
          <span class="muted">पहले 10 फोटो दिखेंगे। "open" पर click से full-size खुलेगा।</span>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:18px">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <strong>सेल्फ़ी कैमरा</strong>
          <span class="pill" id="camStatus">● offline</span>
        </div>
        <video id="cam" autoplay playsinline style="width:100%;background:#0b0f15;border:1px solid #1f2836;border-radius:10px"></video>
        <div class="row2" style="margin-top:10px">
          <button class="btn sm" id="btnCamStart">Start</button>
          <button class="btn sm" id="btnCamStop">Stop</button>
          <button class="btn sm" id="btnSnap">Snap</button>
        </div>
        <canvas id="snap" style="display:none"></canvas>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <strong>Debug logs</strong>
          <button class="btn sm ghost" id="btnClearLogs">Clear</button>
        </div>
        <div class="logs" id="logs"></div>
      </div>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin:18px 4px 8px">
      <strong>मिले <span id="hitCount">0</span> फोटो।</strong>
      <small class="muted">"open" = presigned URL (via /download)</small>
    </div>

    <div class="grid" id="results"></div>
  </div>

<script>
// ---------- Config & Helpers ----------
const d = (sel) => document.querySelector(sel);
const ls = (k,v) => v===undefined ? localStorage.getItem(k) : localStorage.setItem(k,v);

function API(){
  let base = ls('apiBase') || 'https://oidwg6gcx0.execute-api.ap-south-1.amazonaws.com/PROD2';
  return base.replace(/\/$/, '');
}

function showApi(){
  d('#apiLabel').textContent = API();
  const m = API().match(/\/([A-Za-z0-9_-]+)$/); // stage suffix
  d('#stageChip').textContent = 'Stage: ' + (m?m[1]:'?');
}
showApi();

function now(){ return new Date().toISOString(); }
function log(level, obj){
  try{ console[level==='error'?'error':'log']({time: now(), level, obj}); }catch{}
  const line = document.createElement('div'); line.className = 'logline';
  const t = document.createElement('div'); t.className='t'; t.textContent = now();
  const lv = document.createElement('div'); lv.className='lvl '+level; lv.textContent=level;
  const pre = document.createElement('pre'); pre.textContent = (typeof obj==='string')?obj:JSON.stringify(obj, null, 2);
  pre.style.margin=0; pre.style.whiteSpace='pre-wrap'; pre.style.wordBreak='break-word';
  line.append(t, lv, pre); d('#logs').append(line); d('#logs').scrollTop = d('#logs').scrollHeight;
}

function withExt(key=''){
  // Ensure a file extension (default .jpg). If already has dot, keep as is.
  return /\.[a-z0-9]{3,4}$/i.test(key) ? key : key + '.jpg';
}

function thumbURL(ev, key, w=256){
  const k = withExt(key||'');
  const q = new URLSearchParams({ eventId: ev||'', key: k, w: String(w), orient: '1', failOn: 'none' });
  return `${API()}/thumb?${q}`;
}

async function openFull(eventId, key){
  try{
    const k = withExt(key||'');
    const q = new URLSearchParams({ eventId, key: k });
    const url = `${API()}/download?${q}`;
    const res = await fetch(url);
    const text = await res.text();
    let data = null; try{ data = JSON.parse(text); }catch{}
    log('info', {event:'download', url, status:res.status, raw:text.slice(0,400)});
    if(data && data.url){ window.open(data.url, '_blank'); }
    else{ alert('Open failed: '+(text||res.status)); }
  }catch(e){ alert('Open failed: '+e.message); }
}

async function jpost(url, body){
  const payload = JSON.stringify(body||{});
  log('info', {event:'request', url, method:'POST', headers:{'Content-Type':'application/json'}, body:payload});
  const t0 = performance.now();
  const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body:payload });
  const text = await res.text();
  const t1 = performance.now();
  log('info', {event:'response', url, status:res.status, took_ms:Math.round(t1-t0), headers:Object.fromEntries(res.headers.entries()), raw:text.slice(0,400)});
  if(!res.ok) throw new Error(`HTTP ${res.status}: ${text}`);
  try{ return JSON.parse(text); }catch(_){ return text; }
}

// ---------- Camera ----------
let stream = null; let snapData = null;
async function startCam(){
  try{
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:'user' }, audio:false });
    d('#cam').srcObject = stream; d('#camStatus').textContent='● online';
    d('#camStatus').style.background='#1e2a22'; d('#camStatus').style.color='#b6f7c8';
    log('info', 'camera started');
  }catch(e){ log('error', 'camera error: '+e.message); alert('Camera error: '+e.message); }
}
function stopCam(){ try{ stream?.getTracks().forEach(t=>t.stop()); }catch{} stream=null; d('#cam').srcObject=null; d('#camStatus').textContent='● offline'; d('#camStatus').style.background='var(--chip2)'; d('#camStatus').style.color='#cbd8f1'; }
function snap(){
  if(!stream){ alert('Camera is not running'); return; }
  const v = d('#cam'); const c = d('#snap'); const r = window.devicePixelRatio||1;
  const w = v.videoWidth || 640, h = v.videoHeight || 480;
  c.width = w; c.height = h; const g = c.getContext('2d'); g.drawImage(v,0,0,w,h);
  snapData = c.toDataURL('image/jpeg', 0.92);
  log('info', {event:'snap', size: snapData?.length});
}

// ---------- Search ----------
function parseEvents(s){
  if(!s) return [];
  return s.split(',').map(x=>x.trim()).filter(Boolean);
}

function renderResults(list){
  const grid = d('#results'); grid.innerHTML='';
  (list||[]).forEach((it,idx)=>{
    const card = document.createElement('div'); card.className='result';

    const th = document.createElement('div'); th.className='thumb'; th.textContent='No preview';
    const img = document.createElement('img'); img.style.display='none';
    if(d('#optThumbs').checked){
      img.src = thumbURL(it.eventId, it.key || it.id);
      img.onload = ()=>{ th.textContent=''; img.style.display='block'; };
      img.onerror = ()=>{ th.textContent='preview failed'; };
      th.append(img);
    }
    card.append(th);

    const meta = document.createElement('div'); meta.className='meta';
    const pill = document.createElement('span'); pill.className='pill'; pill.textContent = (it.score!=null?`~${Math.round(it.score*100)}%`:'~100%');
    const m = document.createElement('div'); m.style.marginTop='6px'; m.innerHTML = `<div class="muted">ID:</div><div style="word-break:break-all">${it.id||it.key}</div><div class="muted" style="margin-top:6px">Event:</div><div>${it.eventId||'?'}</div>`;
    meta.append(pill, m); card.append(meta);

    const row2 = document.createElement('div'); row2.className='row2';
    const bOpen = document.createElement('button'); bOpen.className='btn sm'; bOpen.textContent='open';
    bOpen.onclick = ()=> openFull(it.eventId, it.key||it.id);
    const bCopy = document.createElement('button'); bCopy.className='btn sm ghost'; bCopy.textContent='copy id';
    bCopy.onclick = async ()=>{ await navigator.clipboard.writeText(it.id||''); bCopy.textContent='copied'; setTimeout(()=>bCopy.textContent='copy id', 1200); };
    row2.append(bOpen,bCopy); card.append(row2);

    grid.append(card);
  });
}

async function doSearch(){
  try{
    const requireSelfie = d('#optRequireSelfie').checked;
    if(requireSelfie && !snapData){ alert('Selfie आवश्यक है। पहले Start → Snap करें।'); return; }

    const body = {
      name: d('#name').value.trim() || undefined,
      phone: d('#phone').value.trim() || undefined,
      limit: Number(d('#limit').value) || 50,
      eventIds: parseEvents(d('#eventIds').value)
      // यदि backend selfie स्वीकार करता है, यहाँ base64 भेजें: face: snapData
    };

    const url = API()+ '/search';
    const resp = await jpost(url, body);
    const count = Number(resp?.count ?? 0);
    d('#hitCount').textContent = count;
    renderResults(resp?.results||[]);
  }catch(e){
    log('error', 'search error: '+ e.message);
    alert('खोज में दिक्कत: '+ e.message);
  }
}

// ---------- UI wiring ----------

d('#btnChangeApi').onclick = () => {
  const cur = API();
  const x = prompt('Enter API base (example: https://xyz.execute-api.ap-south-1.amazonaws.com/PROD2)', cur);
  if(x){ ls('apiBase', x.trim()); showApi(); }
};

d('#btnClearCache').onclick = () => { localStorage.clear(); alert('Local cache cleared'); showApi(); };

d('#btnToggleLogs').onclick = () => { document.querySelector('.row').scrollIntoView({behavior:'smooth'}); };

// camera controls
 d('#btnCamStart').onclick = startCam;
 d('#btnCamStop').onclick = stopCam;
 d('#btnSnap').onclick = snap;

// search
 d('#btnSearch').onclick = doSearch;
 d('#btnClear').onclick = () => { ['#name','#phone','#eventIds'].forEach(sel=>d(sel).value=''); d('#limit').value=50; };
 d('#btnClearLogs').onclick = () => d('#logs').innerHTML='';

// initial
log('info', 'UI ready');
</script>
</body>
</html>
