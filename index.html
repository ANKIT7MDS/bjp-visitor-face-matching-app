
<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Face Search — Upload Ready</title>
<style>
  :root{
    --brand:#ff8a00;
    --brand-dark:#e57700;
    --ink:#222;
    --muted:#6b7280;
    --bg:#faf7f2;
    --card:#fff;
    --ok:#0a7f33;
    --bad:#b91c1c;
    --chip:#111827;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif;background:var(--bg);color:var(--ink)}
  .wrap{max-width:1080px;margin-inline:auto;padding:16px}
  h1{font-weight:700;font-size:20px;margin:6px 0 14px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:860px){.row{grid-template-columns:1fr}}
  .card{background:var(--card);border-radius:12px;box-shadow:0 1px 2px rgba(16,24,40,.06);padding:14px}
  label{display:block;font-size:13px;color:var(--muted);margin:8px 0 6px}
  input[type=text]{width:100%;padding:12px 14px;border:1px solid #e5e7eb;border-radius:8px;font-size:16px;background:#fff}
  .btn{display:inline-flex;justify-content:center;align-items:center;gap:8px;background:var(--brand);color:#fff;border:0;border-radius:10px;padding:14px 18px;font-weight:700;cursor:pointer;transition:.15s}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn:hover{background:var(--brand-dark)}
  .btn.ghost{background:#111827;color:#fff}
  .hint{font-size:13px;color:#374151}
  .status{margin-top:10px;border:1px dashed #fca5a5;background:#fef2f2;color:#7f1d1d;border-radius:10px;padding:12px 14px}
  .status.ok{background:#ecfdf5;border-color:#86efac;color:#065f46}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  @media (min-width:720px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
  @media (min-width:1024px){.grid{grid-template-columns:repeat(4,minmax(0,1fr))}}
  .photo{position:relative;background:#f3f4f6;border-radius:10px;overflow:hidden;min-height:160px}
  .photo img{width:100%;height:200px;object-fit:cover;display:block;background:#e5e7eb}
  .chip{position:absolute;left:8px;top:8px;background:rgba(17,24,39,.85);color:#fff;border-radius:999px;padding:4px 8px;font-size:12px}
  .dl{position:absolute;right:8px;bottom:8px;background:#111827aa;color:#fff;border-radius:8px;padding:6px 8px;text-decoration:none;font-size:18px}
  .sel{position:absolute;inset:0;border:3px solid transparent;cursor:pointer}
  .sel.selected{border-color:var(--brand)}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 0}
  .pill{display:inline-flex;align-items:center;gap:6px;background:#111827;color:#fff;border-radius:999px;padding:6px 10px;font-size:12px}
  .hide-mobile{}
  @media (pointer:coarse){ .hide-mobile{display:none !important} }
  .video-box{position:relative;background:#000;border-radius:12px;overflow:hidden;max-height:420px}
  video,canvas{width:100%;height:auto;display:block}
  .video-actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
  .note{font-size:12px;color:#6b7280;margin-top:8px}
  .sr{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
</style>
</head>
<body>
  <div class="wrap">
    <h1>भारतीय जनता पार्टी — मंदसौर (Face Search)</h1>

    <div class="row">
      <section class="card">
        <div class="row" style="grid-template-columns:1fr 1fr">
          <div>
            <label>नाम (अनिवार्य)</label>
            <input id="name" type="text" placeholder="अपना नाम"/>
          </div>
          <div>
            <label>मोबाइल नंबर (अनिवार्य)</label>
            <input id="mobile" inputmode="numeric" pattern="[0-9]*" maxlength="10" placeholder="10 अंकों का मोबाइल"/>
          </div>
        </div>

        <label class="hide-mobile" style="margin-top:12px">या फ़ाइल चुनें</label>
        <div id="fileInputWrap" class="hide-mobile">
          <input id="file" type="file" accept="image/*"/>
        </div>

        <div class="video-box" style="margin-top:12px">
          <video id="video" playsinline autoplay muted></video>
          <canvas id="snap" class="sr"></canvas>
        </div>
        <div class="video-actions">
          <button id="btnStart" class="btn">कैमरा चालू करें</button>
          <button id="btnShot" class="btn ghost">सेल्फ़ी लें</button>
          <button id="btnRetry" class="btn ghost">दोबारा लें</button>
          <div id="camState" class="pill">कैमरा: <b id="camLabel">OFF</b></div>
          <div id="shotState" class="pill">सेल्फ़ी: <b id="shotLabel">❌</b></div>
        </div>

        <button id="btnSearch" class="btn" style="margin-top:14px;width:100%">Search</button>

        <div id="status" class="status" style="display:none"></div>
        <p class="note">PNG/WebP → JPEG auto. * मोबाइल पर कैमरा अपने‑आप खुलेगा (Allow दें) । फ़ाइल अपलोड की ज़रूरत नहीं।</p>
      </section>

      <section class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div class="pill">मिले <b id="found">0</b> फोटो।</div>
          <div class="toolbar">
            <button id="btnSelAll" class="btn ghost" title="Select All">Select All</button>
            <button id="btnClear" class="btn ghost" title="Clear">Clear</button>
            <button id="btnBulk" class="btn" title="Download Selected">Download Selected</button>
          </div>
        </div>
        <div id="grid" class="grid" style="margin-top:12px"></div>
      </section>
    </div>
  </div>

<script>
  <script>
// ===== API CONFIG (EDIT HERE) =====
const API_BASE_DEFAULT = 'https://oidwg6gcx0.execute-api.ap-south-1.amazonaws.com/PROD2';

// URL priority: ?api=...  -> localStorage -> default
const API_BASE = (
  new URLSearchParams(location.search).get('api') ||
  localStorage.getItem('apiBase') ||
  API_BASE_DEFAULT
).replace(/\/+$/,''); // trailing slash हटाने के लिए

// चाहें तो lock कर दें ताकि आगे से हमेशा यही रहे:
localStorage.setItem('apiBase', API_BASE);

// helper: किसी भी रूट का पूरा URL बनाता है
const api = (p='') => `${API_BASE}${p.startsWith('/') ? p : '/' + p}`;
</script>

(function(){
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];
  const qs = k => new URLSearchParams(location.search).get(k);
  const apiBase = qs('api');
  const eventId = qs('event') || 'demo-2025-01';
  const demo = qs('demo') === '1' || !apiBase || location.protocol === 'file:';
  const newTab = qs('newtab') === '1';

  const el = {
    name: $('#name'),
    mobile: $('#mobile'),
    file: $('#file'),
    video: $('#video'),
    snap: $('#snap'),
    btnStart: $('#btnStart'),
    btnShot: $('#btnShot'),
    btnRetry: $('#btnRetry'),
    btnSearch: $('#btnSearch'),
    status: $('#status'),
    camLabel: $('#camLabel'),
    shotLabel: $('#shotLabel'),
    grid: $('#grid'),
    found: $('#found'),
    btnSelAll: $('#btnSelAll'),
    btnClear: $('#btnClear'),
    btnBulk: $('#btnBulk'),
  };

  let stream = null;
  let lastShotDataUrl = null;
  let items = [];
  const selected = new Set();

  // Helpers
  const setStatus = (msg, ok=false) => {
    el.status.style.display = 'block';
    el.status.classList.toggle('ok', !!ok);
    el.status.innerHTML = msg;
  };
  const clearStatus = () => { el.status.style.display = 'none'; }

  const isMobile = () => matchMedia('(pointer:coarse)').matches;

  // Hide file picker on mobile (unless debug=1)
  const debug = qs('debug') === '1';
  if (isMobile() && !debug) {
    const wrap = document.getElementById('fileInputWrap');
    if (wrap) wrap.style.display = 'none';
  }

  // Camera
  async function startCamera() {
    try{
      stream?.getTracks()?.forEach(t => t.stop());
      stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}, audio:false});
      el.video.srcObject = stream;
      el.camLabel.textContent = 'ON';
      el.video.play().catch(()=>{});
    }catch(err){
      console.warn('camera error', err);
      setStatus('कैमरा एरर: अनुमति दें या किसी और ब्राउज़र से कोशिश करें।', false);
    }
  }
  function stopCamera(){
    stream?.getTracks()?.forEach(t => t.stop());
    stream = null;
    el.camLabel.textContent = 'OFF';
  }
  function takeShot(){
    const v = el.video;
    if (!v.videoWidth) return null;
    const c = el.snap;
    c.width = v.videoWidth; c.height = v.videoHeight;
    const g = c.getContext('2d');
    g.drawImage(v, 0, 0, c.width, c.height);
    // Slight JPEG compression to keep payload light
    lastShotDataUrl = c.toDataURL('image/jpeg', .9);
    el.shotLabel.textContent = '✅';
    return lastShotDataUrl;
  }

  el.btnStart.addEventListener('click', startCamera);
  el.btnRetry.addEventListener('click', ()=>{ lastShotDataUrl=null; el.shotLabel.textContent='❌'; });
  el.btnShot.addEventListener('click', takeShot);

  // Auto‑camera on mobile
  if (isMobile()) setTimeout(()=>el.btnStart.click(), 400);

  // Read file to dataURL
  const readFileAsDataUrl = file => new Promise((res, rej)=>{
    const r = new FileReader();
    r.onload = () => res(r.result);
    r.onerror = rej;
    r.readAsDataURL(file);
  });

  // API helpers
  async function fetchJSON(url, opts={}){
    const t = setTimeout(()=>controller.abort(), 30000);
    const controller = new AbortController();
    try{
      const r = await fetch(url, {...opts, signal:controller.signal});
      const body = await r.text();
      let data = null;
      try{ data = body ? JSON.parse(body) : null; }catch(e){ /* keep text */ }
      if (!r.ok) {
        console.warn('api error', r.status, body);
        throw new Error(`API ${r.status}`);
      }
      return data ?? {};
    }finally{
      clearTimeout(t);
    }
  }

  function render(itemsList){
    items = itemsList || [];
    el.grid.innerHTML = '';
    el.found.textContent = items.length;
    selected.clear();

    if (!items.length){
      setStatus('कोई रिज़ल्ट नहीं मिला।', false);
      return;
    }
    clearStatus();

    for (const it of items){
      const key = it.s3Key || it.key || '';
      const imgSrc = demo
        ? placeholder(it.photoId || 'IMG')
        : `${apiBase.replace(/\/$/,'')}/download?key=${encodeURIComponent(key)}`;

      const card = document.createElement('div');
      card.className = 'photo';
      card.innerHTML = `
        <img loading="lazy" src="${imgSrc}" alt="${it.photoId || ''}"/>
        <a class="dl" target="_blank" href="${imgSrc}" title="Download">⬇</a>
        <div class="chip">${(it.photoId || '').toString().slice(0,16)} • ~${Math.round((it.similarity||it.score||0))}%</div>
        <div class="sel"></div>
      `;
      const sel = card.querySelector('.sel');
      sel.addEventListener('click', () => {
        if (selected.has(key)) { selected.delete(key); sel.classList.remove('selected'); }
        else { selected.add(key); sel.classList.add('selected'); }
      });
      el.grid.appendChild(card);
    }
  }

  // Placeholders for demo/offline
  function placeholder(label='IMG'){
    // simple SVG preview (fast + no network)
    const svg = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='600' height='400'>
      <defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
        <stop offset='0' stop-color='#f5f5f5'/><stop offset='1' stop-color='#ddd'/>
      </linearGradient></defs>
      <rect width='100%' height='100%' fill='url(#g)'/>
      <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle'
        font-family='Arial,Helvetica' font-size='36' fill='#444'>${label}</text>
    </svg>`);
    return `data:image/svg+xml,${svg}`;
  }

  // Bulk download – open a new tab with link list (mobile friendly)
  el.btnBulk.addEventListener('click', () => {
    if (!selected.size) { setStatus('कोई फोटो चुना नहीं है।', false); return; }
    const w = window.open('', '_blank');
    w.document.write('<title>Download Selected</title><h3>Tap links to download</h3>');
    const base = demo ? '' : apiBase.replace(/\/$/,'');
    for (const k of selected) {
      const href = demo ? placeholder('IMG') : `${base}/download?key=${encodeURIComponent(k)}`;
      w.document.write(`<p><a href="${href}" download target="_blank">${k}</a></p>`);
    }
    w.document.close();
  });
  el.btnSelAll.addEventListener('click', () => {
    selected.clear();
    $$(' .photo .sel', el.grid).forEach((s,i)=>{
      const key = items[i]?.s3Key || items[i]?.key; if(!key) return;
      selected.add(key); s.classList.add('selected');
    });
  });
  el.btnClear.addEventListener('click', () => {
    selected.clear();
    $$(' .photo .sel', el.grid).forEach(s=>s.classList.remove('selected'));
  });

  // Validate 10-digit
  function validMobile(m){ return /^[6-9][0-9]{9}$/.test((m||'').trim()); }

  // SEARCH
  el.btnSearch.addEventListener('click', doSearch);
  async function doSearch(){
    try{
      const name = el.name.value.trim();
      const mobile = el.mobile.value.trim();
      if (!name){ setStatus('कृपया नाम भरें।'); return; }
      if (!validMobile(mobile)){ setStatus('कृपया 10 अंकों का मोबाइल भरें।'); return; }

      el.btnSearch.disabled = true;
      setStatus('खोज जारी है…');

      let imageBase64 = null;

      // priority: file → selfie → (demo fallback)
      if (el.file.files?.[0]) {
        const dataUrl = await readFileAsDataUrl(el.file.files[0]);
        imageBase64 = dataUrl.split(',')[1];
      } else if (lastShotDataUrl) {
        imageBase64 = lastShotDataUrl.split(',')[1];
      }

      if (demo){
        // offline/demo results
        const mocks = Array.from({length:10}).map((_,i)=>({
          s3Key:`events/${eventId}/originals/IMG_${String(3800+i).padStart(4,'0')}.jpg`,
          similarity: 100 - i,
          photoId: `IMG_${String(3800+i).padStart(4,'0')}`
        }));
        render(mocks);
        setStatus('DEMO मोड: नेटवर्क के बिना नकली थम्बनेल दिखाए जा रहे हैं।', true);
        return;
      }

      // Real API
      const body = {
        name, mobile, eventId,
        imageBase64
      };
      const resp = await fetchJSON(`${apiBase.replace(/\/$/,'')}/search`, {
        method:'POST',
        headers:{'content-type':'application/json'},
        body:JSON.stringify(body)
      });

      const results = resp?.results || resp?.items || resp || [];
      render(results);
      setStatus(`मिले ${results.length} फोटो।`, true);

      if (newTab){
        const w = window.open('', '_blank');
        w.document.write('<title>Search Results</title>');
        for (const it of results){
          const key = it.s3Key || it.key || '';
          const href = `${apiBase.replace(/\/$/,'')}/download?key=${encodeURIComponent(key)}`;
          w.document.write(`<p><a href="${href}" target="_blank">${it.photoId || key}</a></p>`);
        }
        w.document.close();
      }
    }catch(err){
      console.error('search error', err);
      setStatus(`सर्व में दिक्कत: ${err.message || err}`, false);
    }finally{
      el.btnSearch.disabled = false;
    }
  }

  // Autofocus
  el.name.focus();
})();
</script>
</body>
</html>
