<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8">
  <title>Face Search</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{ --brand:#ff7a18; --brand-ink:#fff; --bg:#fff8f0; --card:#fff; --ink:#1f2328; --muted:#6b7280; --border:#e5e7eb; --shadow:0 1px 2px rgba(0,0,0,.05),0 8px 24px -16px rgba(0,0,0,.15); --ok:#0f9d58; --radius:14px }
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(90deg,var(--brand),#ffa149);color:var(--brand-ink);padding:14px clamp(14px,3vw,24px);font-weight:800}
    main{padding:clamp(12px,2.8vw,22px);max-width:1080px;margin:auto}
    .layout{display:grid;gap:clamp(10px,2.2vw,16px);grid-template-columns:1.15fr .85fr} @media(max-width:980px){.layout{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .card .hd{padding:12px 16px;border-bottom:1px solid var(--border);font-weight:700;display:flex;align-items:center;gap:8px}
    .card .bd{padding:clamp(12px,2.4vw,18px)}
    label{display:block;margin:12px 0 6px;font-weight:650}
    input[type=text],input[type=tel],input[type=file]{width:100%;padding:13px 14px;border:1px solid var(--border);border-radius:12px;background:transparent;color:inherit;font:inherit;outline:none}
    .row{display:flex;gap:12px;flex-wrap:wrap} .row>div{flex:1 1 260px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;background:var(--brand);color:var(--brand-ink);border:0;border-radius:12px;padding:13px 18px;font-weight:800;cursor:pointer;box-shadow:var(--shadow)}
    .btn.gray{background:#5a5f69;color:#fff} .btn[disabled]{opacity:.6;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px}
    .thumb{width:100%;aspect-ratio:1/1;object-fit:cover;background:#f3f3f3;border-radius:12px;border:1px solid var(--border);image-orientation: from-image;}
    .meta{font-size:.92rem;color:#68707a;margin-top:8px}
    .pill{display:inline-block;padding:3px 10px;border-radius:999px;background:#ffe4ce;color:#b35500;font-weight:700;font-size:.8rem}
    .ok{color:var(--ok);font-weight:700}
    .muted{color:var(--muted)} .msg{padding:12px;border:1px dashed var(--border);border-radius:12px;background:rgba(0,0,0,.02)}
    #video{width:100%;aspect-ratio:4/3;background:#000;border-radius:14px} #canvas{width:100%;display:none;border-radius:14px}
    #seeMore{margin-top:12px;width:100%}
  </style>
</head>
<body>
  <header>Face Search</header>
  <main>
    <div class="layout">
      <section class="card">
        <div class="hd">खोज</div>
        <div class="bd">
          <div class="row">
            <div style="flex:1">
              <label>नाम <span class="muted">(अनिवार्य)</span></label>
              <input id="name" type="text" placeholder="आपका नाम" autocomplete="name" required>
            </div>
            <div style="flex:1">
              <label>मोबाइल नंबर <span class="muted">(अनिवार्य)</span></label>
              <input id="mobile" type="tel" placeholder="10 अंकों का नंबर" maxlength="10" inputmode="numeric" required>
            </div>
          </div>

          <details id="adv" style="margin:6px 0 8px"><summary class="muted">Advanced (optional)</summary>
            <label>Event IDs <span class="muted">(कॉमा से अलग; खाली छोड़ें—ऑटो)</span></label>
            <input id="eventIds" type="text" placeholder="उदा: EVT_2025_08_12, demo-2025-01">
          </details>

          <label class="stat">सेल्फी कैमरा</label>
          <video id="video" playsinline autoplay muted></video>
          <canvas id="canvas"></canvas>

          <div class="row" style="margin-top:10px">
            <button id="btnSnap" class="btn">सेल्फ़ी लें</button>
            <button id="btnRetake" class="btn gray" type="button">दोबारा लें</button>
          </div>

          <div class="muted" id="selfieStatus" style="margin-top:8px">सेल्फ़ी तैयार करें या फ़ाइल चुनें।</div>

          <label class="stat" style="margin-top:12px">या फ़ाइल चुनें</label>
          <input id="fileInput" type="file" accept="image/*">

          <div class="row" style="margin-top:12px">
            <button id="btnSearch" class="btn" style="min-width:160px">Search</button>
            <button id="btnRunTests" class="btn gray" type="button" title="Self-tests">Run Tests</button>
          </div>

          <div id="status" style="margin-top:10px"></div>
          <details id="errBox" class="err"><summary>एरर डीटेल्स</summary><pre id="errText" style="white-space:pre-wrap"></pre></details>
        </div>
      </section>

      <section class="card">
        <div class="hd">परिणाम</div>
        <div class="bd">
          <div id="found" class="ok" style="display:none"></div>
          <div id="results" class="grid"></div>
          <button id="seeMore" class="btn gray" style="display:none">और दिखाएँ</button>
          <div id="empty" class="msg" style="display:none">कोई फोटो नहीं मिला।</div>
        </div>
      </section>
    </div>
  </main>

<script>
// ===== CONFIG =====
const API_BASE = 'https://oidwg6gcx0.execute-api.ap-south-1.amazonaws.com/PROD2';
const DEFAULT_SIM = 70;          // backend sim threshold
const UI_PAGE_SIZE  = 10;        // UI में एक बार में 10 कार्ड
const BACKEND_LIMIT = 50;        // एक API कॉल में 50 रिज़ल्ट मांगेंगे

// ===== DOM =====
const $ = s => document.querySelector(s);
const nameEl=$('#name'), mobileEl=$('#mobile'), eventEl=$('#eventIds');
const video=$('#video'), canvas=$('#canvas'), fileEl=$('#fileInput');
const btnSnap=$('#btnSnap'), btnRetake=$('#btnRetake'), btnSearch=$('#btnSearch'), btnRunTests=$('#btnRunTests');
const resultsEl=$('#results'), emptyEl=$('#empty'), foundEl=$('#found'), seeMoreBtn=$('#seeMore');
const errBox=$('#errBox'), errText=$('#errText'), statusEl=$('#status');

// ===== STATE =====
const state={ stream:null, imageBase64:'', imgBytes:0, lastFileName:'', items:[], total:null, nextToken:null, page:0, loading:false };

// ===== HELPERS =====
function stripDataUrl(u){ const i=u.indexOf(','); return i>-1?u.slice(i+1):u; }
function validMobile(m){ return /^\d{10}$/.test((m||'').trim()); }
function statusMsg(msg,type){ statusEl.innerHTML = type==='err'?`<div style="color:#b00020">${msg}</div>`:msg; }
function parseEventInput(raw){ raw=(raw||'').trim(); if(!raw) return {}; const arr=raw.split(',').map(t=>t.trim()).filter(Boolean); return arr.length<=1? {eventId:arr[0]} : {eventIds:arr}; }
function getId(r){ return r.photoId || r.id || r.imageId || r.photoID || ''; }
function getScore(r){ const v=r.similarity ?? r.score ?? r.confidence ?? 0; return Math.round(v*100)/100; }
function evFrom(r){ if(r.eventId) return r.eventId; if(r.s3Key && r.s3Key.startsWith('events/')) return r.s3Key.split('/')[1]; return ''; }
function primaryKey(r){ return r.s3Key || r.key || r.s3key || r.path || r.urlKey || ''; }

// मजबूत de-dupe (copy suffix/ random hash हटाना)
function normalizeId(s='') {
  s = s.toLowerCase();
  s = s.replace(/(?:-copy-\d+|\(\d+\)|_copy(?:_\d+)?)/g, '');
  const m = s.match(/^(fb_img_\d{10,})/); if (m) return m[1];
  s = s.replace(/(\d{8}_\d{6})_[a-z0-9]{6,}$/,'$1');
  s = s.replace(/(__|_)[a-z0-9]{6,}(?=\.|$)/g,'$1');
  return s;
}
function dedupe(list) {
  const map = new Map();
  for (const it of (list||[])) {
    const pk  = (primaryKey(it) || '').toString();
    const pid = (getId(it) || '').toString();
    const ev  = (evFrom(it) || '').toString();
    const canon = (pk && normalizeId(pk)) || (pid && (ev + '|' + normalizeId(pid))) || pk || (ev + '|' + pid);
    if (canon && !map.has(canon)) map.set(canon, it);
  }
  return [...map.values()];
}

// ===== CAMERA =====
async function startCamera(){
  try{
    state.stream?.getTracks()?.forEach(t=>t.stop());
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'},audio:false});
    state.stream=stream; video.srcObject=stream; await video.play().catch(()=>{});
  }catch{ statusMsg('कैमरा उपलब्ध नहीं। फ़ाइल से भी खोज हो जाएगी।'); }
}
function snapshot(){
  const w=video.videoWidth||720,h=video.videoHeight||720;
  canvas.width=w;canvas.height=h;
  const ctx=canvas.getContext('2d');
  ctx.drawImage(video,0,0,w,h);
  const dataUrl=canvas.toDataURL('image/jpeg',.9);
  state.imageBase64=stripDataUrl(dataUrl);
  state.imgBytes=Math.round((state.imageBase64.length*3)/4);
  canvas.style.display='block'; video.style.display='none';
}
async function useFile(file){
  const dataUrl=await new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); });
  const img=new Image(); await new Promise((res,rej)=>{ img.onload=res; img.onerror=rej; img.src=dataUrl; });
  const w=img.width||720,h=img.height||720; canvas.width=w;canvas.height=h;
  const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h);
  const jpeg=canvas.toDataURL('image/jpeg',.9);
  state.imageBase64=stripDataUrl(jpeg); state.imgBytes=Math.round((state.imageBase64.length*3)/4);
  canvas.style.display='block'; video.style.display='none';
}

// ===== EVENTS =====
btnSnap.addEventListener('click', e=>{ e.preventDefault(); if(!video.srcObject) startCamera(); snapshot(); statusMsg(`सेल्फ़ी तैयार ✓ (${state.imgBytes} bytes)`); });
btnRetake.addEventListener('click', e=>{ e.preventDefault(); canvas.style.display='none'; video.style.display='block'; state.imageBase64=''; statusMsg('सेल्फ़ी फिर से लें या फ़ाइल चुनें।'); });
fileEl.addEventListener('change', e=>{ const f=e.target.files?.[0]; if(f) useFile(f); });
btnSearch.addEventListener('click', e=>{ e.preventDefault(); doSearch(); });
seeMoreBtn.addEventListener('click', e=>{ e.preventDefault(); renderNextPage(); });

// ===== NET =====
async function fetchJSON(url,opt={}){ const r=await fetch(url,opt); const ct=(r.headers.get('content-type')||'').toLowerCase(); const d=ct.includes('json')? await r.json(): await r.text(); if(!r.ok) throw new Error(typeof d==='string'?d:JSON.stringify(d)); return d; }

async function searchPage(cursor){
  const evObj=parseEventInput(eventEl.value);
  const body={ ...evObj, imageBase64:state.imageBase64, name:(nameEl.value||'').trim(), mobile:(mobileEl.value||'').trim(), sim:DEFAULT_SIM, limit:BACKEND_LIMIT };
  if(cursor) body.cursor = cursor;
  const data=await fetchJSON(API_BASE+'/search',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  const items = data?.items || data?.results || data?.matches || [];
  return { items, nextToken: data?.nextToken || null, total: data?.total ?? null };
}

// ===== SEARCH FLOW =====
async function doSearch(){
  if(state.loading) return; errBox.open=false; errText.textContent='';
  const nm=(nameEl.value||'').trim(); const mb=(mobileEl.value||'').trim(); if(!nm) return statusMsg('कृपया नाम भरें।','err'); if(!validMobile(mb)) return statusMsg('कृपया 10 अंकों का मोबाइल भरें।','err');
  if(!state.imageBase64){ if(video.srcObject){ snapshot(); } }
  if(!state.imageBase64) return statusMsg('कृपया सेल्फ़ी लें या फ़ाइल चुनें।','err');

  state.loading=true; btnSearch.disabled=true; resultsEl.innerHTML=''; emptyEl.style.display='none'; seeMoreBtn.style.display='none';
  state.items=[]; state.total=null; state.nextToken=null; state.page=0;
  statusMsg('खोज जारी है…');
  try{
    const {items, nextToken, total} = await searchPage(null);
    state.items = dedupe(items);
    state.total = total; state.nextToken = nextToken; state.page=0;
    foundEl.style.display='block';
    foundEl.textContent = (typeof total==='number') ? `मिले ${state.items.length}/${total} फोटो।` : `मिले ${state.items.length} फोटो।`;
    renderNextPage(true);
    statusMsg('');
  }catch(err){ statusMsg('सर्वर में दिक्कत: '+err.message,'err'); errText.textContent=err.stack||String(err); errBox.open=true; }
  finally{ state.loading=false; btnSearch.disabled=false; }
}

// ===== THUMB + DOWNLOAD FALLBACK =====
async function presign(key){ const d=await fetchJSON(API_BASE+'/download?key='+encodeURIComponent(key)); if(d&&/^https?:\/\//i.test(d.url)) return d.url; throw new Error('presign failed'); }
function buildKeyCandidates(r){
  const pid=getId(r); const ev=evFrom(r); const keys=[]; const prim=primaryKey(r); if(prim) keys.push(prim);
  if(ev && pid){
    const exts=['.jpg','.jpeg','.png','.webp','.JPG','.JPEG'];
    const bases=[`events/${ev}/`,`events/${ev}/originals/`,`events/${ev}/raw/`,`events/${ev}/uploads/`,`images/${ev}/`];
    for(const base of bases){ for(const ext of exts){ keys.push(`${base}${pid}${ext}`); } }
  }
  return keys.filter(Boolean);
}
function pLimit(n){ let running=0; const q=[]; const run=()=>{ if(!q.length||running>=n) return; const {fn,ok,fail}=q.shift(); running++; fn().then(ok,fail).finally(()=>{ running--; run(); }); }; return fn=>new Promise((res,rej)=>{ q.push({fn,ok:res,fail:rej}); run(); }); }
const limit = pLimit(6);
async function loadFromKeys(img, keys){ for(const key of keys){ try{ const url=await presign(key); img.src=url; img.dataset.loaded='1'; return; }catch(e){} } img.replaceWith(makeNoPreview()); }
function thumbUrlForKey(key,w=512){ return `${API_BASE}/thumb?key=${encodeURIComponent(key)}&w=${w}&orient=1`; }
function makeNoPreview(){ const ph=document.createElement('div'); ph.className='thumb'; ph.style.display='flex'; ph.style.alignItems='center'; ph.style.justifyContent='center'; ph.style.color='#888'; ph.textContent='No preview'; return ph; }
function hydrateThumbs(container){ const imgs=(container||resultsEl).querySelectorAll('img[data-first]'); imgs.forEach(img=>{ const first=decodeURIComponent(img.dataset.first||''); const rest=JSON.parse(img.dataset.keys||'[]'); img.onerror=()=>{ limit(()=>loadFromKeys(img,[first,...rest])); }; img.src = thumbUrlForKey(first); }); }

// ===== RENDER =====
function cardHTML(r){
  const pid=getId(r); const sim=getScore(r);
  const keys=buildKeyCandidates(r); const first=keys[0]||''; const rest=JSON.stringify(keys.slice(1));
  return `
  <div class="cardR">
    ${ first
      ? `<img class=\"thumb\" loading=\"lazy\" alt=\"${pid||'photo'}\" data-first=\"${encodeURIComponent(first)}\" data-keys='${rest}'>`
      : `<div class=\"thumb\" style=\"display:flex;align-items:center;justify-content:center;color:#888\">No preview</div>`}
    <div class="meta">
      ${pid?`<div><b>ID:</b> ${pid}</div>`:''}
      ${sim?`<div><span class="pill">~${sim}%</span> match</div>`:''}
      ${primaryKey(r)?`<div class="muted" style="word-break:break-all">${primaryKey(r)}</div>`:''}
    </div>
  </div>`;
}

async function maybeFetchMore(){
  if(state.nextToken && state.items.length - (state.page*UI_PAGE_SIZE) <= 0){
    try{
      const {items, nextToken, total} = await searchPage(state.nextToken);
      const before = state.items.length;
      state.items = dedupe(state.items.concat(items));
      state.nextToken = nextToken || null;
      if(typeof total==='number') state.total = total;
      if(typeof state.total==='number'){
        foundEl.textContent = `मिले ${state.items.length}/${state.total} फोटो।`;
      }else{
        foundEl.textContent = `मिले ${state.items.length} फोटो।`;
      }
      // अगर कोई नया आइटम नहीं आया और nextToken खत्म, तो बस लौटो
      if(state.items.length === before && !state.nextToken){ /*no-op*/ }
    }catch(err){ console.warn('next page error', err); }
  }
}

function renderNextPage(reset){
  if(reset){ resultsEl.innerHTML=''; state.page=0; }
  const start=state.page*UI_PAGE_SIZE; const slice=state.items.slice(start, start+UI_PAGE_SIZE);
  if(!slice.length){ seeMoreBtn.style.display = state.nextToken? 'inline-flex':'none'; return; }
  const html=slice.map(cardHTML).join('');
  const frag=document.createElement('div'); frag.innerHTML=html; [...frag.children].forEach(n=>resultsEl.appendChild(n));
  hydrateThumbs(resultsEl);
  state.page++;
  const hasMoreLocal = state.page*UI_PAGE_SIZE < state.items.length;
  seeMoreBtn.style.display = (hasMoreLocal || state.nextToken)? 'inline-flex':'none';
  if(!hasMoreLocal && state.nextToken){ // local खत्म, सर्वर से next पेज उठा लें
    maybeFetchMore();
  }
}

// ===== INIT =====
startCamera().catch(()=>{});
</script>
</body>
</html>
