<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8">
  <title>Face Search</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{
      --brand:#ff7a18; --brand-ink:#fff; --bg:#fff7ef; --card:#ffffff; --ink:#1f2328; --muted:#6b7280; --border:#e5e7eb; --radius:14px;
      --shadow:0 1px 2px rgba(0,0,0,.06), 0 12px 30px -18px rgba(0,0,0,.25);
      --accent:#1f7aec; --ok:#10b981; --warn:#b58900;
    }
    @media (prefers-color-scheme: dark){
      :root{ --brand:#ff8a3d; --brand-ink:#0b0b0b; --bg:#0c0d0f; --card:#111418; --ink:#e7e7e7; --muted:#9aa0a6; --border:#23272e; --shadow:0 1px 2px rgba(0,0,0,.3), 0 10px 22px -16px rgba(0,0,0,.6) }
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", sans-serif}

    header{position:sticky;top:0;z-index:20;background:linear-gradient(90deg,var(--brand),#ffa149);color:var(--brand-ink);padding:14px 18px;font-weight:800}
    main{max-width:1150px;margin:auto;padding:clamp(12px,2.6vw,20px)}

    .layout{display:grid;grid-template-columns:1.1fr .9fr;gap:clamp(10px,2.2vw,18px)}
    @media (max-width:980px){.layout{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .card .hd{padding:12px 16px;border-bottom:1px solid var(--border);font-weight:700}
    .card .bd{padding:clamp(12px,2.4vw,18px)}

    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row>div{flex:1 1 260px}

    label{display:block;margin:10px 0 6px;font-weight:650}
    input[type=text], input[type=tel], input[type=file]{width:100%;padding:13px 14px;border:1px solid var(--border);border-radius:12px;background:transparent;color:inherit;font:inherit}
    input:focus-visible{outline:3px solid color-mix(in srgb, var(--brand) 28%, transparent)}

    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:0;border-radius:12px;padding:12px 18px;font-weight:800;cursor:pointer;background:var(--brand);color:var(--brand-ink);box-shadow:var(--shadow)}
    .btn.gray{background:color-mix(in srgb, var(--ink) 92%, transparent);color:#fff}
    .btn[disabled]{opacity:.6;cursor:not-allowed;box-shadow:none}

    #video{width:100%;aspect-ratio:4/3;background:#000;border-radius:14px}
    #canvas{width:100%;display:none;border-radius:14px}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
    @media (max-width:560px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}

    /* Photo card */
    .pCard{position:relative;border:1px solid var(--border);border-radius:16px;background:var(--card);box-shadow:var(--shadow);overflow:hidden;transition:transform .08s ease}
    .pCard:active{transform:translateY(1px)}
    .thumb{width:100%;aspect-ratio:1/1;object-fit:cover;background:#f1f1f1;display:block}

    /* Selection overlay */
    .pick{position:absolute;top:8px;right:8px;width:28px;height:28px;border-radius:999px;border:2px solid #fff;background:rgba(0,0,0,.35);display:grid;place-items:center}
    .pick svg{width:18px;height:18px;opacity:.0;transition:opacity .12s ease}
    .pCard.sel .pick{background:var(--accent)}
    .pCard.sel .pick svg{opacity:1;filter:drop-shadow(0 1px 1px rgba(0,0,0,.35))}

    .muted{color:var(--muted)}
    .msg{padding:12px;border:1px dashed var(--border);border-radius:12px}
    .danger{background:#fee; color:#b00020; border:1px solid #f5c2c7; padding:12px;border-radius:12px}

    /* Sticky action bar */
    .bar{position:sticky;bottom:10px;z-index:15;margin-top:12px}
    .bar .inner{display:flex;gap:10px;flex-wrap:wrap;background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:10px 12px;align-items:center}
    .bar .count{font-weight:800}

    @media (max-width:480px){.btn{width:100%}}
  </style>
</head>
<body>
  <header>Face Search</header>
  <main>
    <div class="layout">
      <section class="card">
        <div class="hd">खोज</div>
        <div class="bd">
          <div class="row">
            <div><label>नाम <span class="muted">(अनिवार्य)</span></label><input id="name" type="text" placeholder="आपका नाम" autocomplete="name" required></div>
            <div><label>मोबाइल नंबर <span class="muted">(अनिवार्य)</span></label><input id="mobile" type="tel" placeholder="10 अंकों का नंबर" maxlength="10" inputmode="numeric" required></div>
          </div>

          <label class="stat" style="margin-top:8px">सेल्फी कैमरा</label>
          <video id="video" playsinline autoplay muted></video>
          <canvas id="canvas"></canvas>

          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
            <button id="btnSnap" class="btn">सेल्फ़ी लें</button>
            <button id="btnRetake" class="btn gray" type="button">दोबारा लें</button>
          </div>
          <div class="muted" id="selfieStatus" style="margin-top:6px">सेल्फ़ी तैयार करें या फ़ाइल चुनें।</div>

          <label style="margin-top:10px">या फ़ाइल चुनें</label>
          <input id="fileInput" type="file" accept="image/*">

          <div class="muted" style="margin:10px 0 6px">PNG/WebP → JPEG ऑटो. * मोबाइल पर कैमरा अपने-आप खुलेगा (Allow दें)।</div>

          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px">
            <button id="btnSearch" class="btn" style="min-width:150px">Search</button>
            <button id="btnRunTests" class="btn gray" type="button">Run Tests</button>
          </div>

          <div id="status" style="margin-top:8px"></div>
          <details id="errBox" class="err"><summary>एरर डीटेल्स</summary><pre id="errText" style="white-space:pre-wrap"></pre></details>
        </div>
      </section>

      <section class="card">
        <div class="hd">परिणाम</div>
        <div class="bd">
          <div id="found" style="display:none;color:var(--ok);font-weight:800"></div>
          <div id="results" class="grid"></div>
          <div id="empty" class="msg" style="display:none">कोई फोटो नहीं मिला।</div>

          <div class="bar">
            <div class="inner">
              <div class="count" id="selCount">0 selected</div>
              <button id="btnClearSel" class="btn gray" type="button">Clear</button>
              <button id="btnZip" class="btn" disabled>Download ZIP</button>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- JSZip + FileSaver for ZIP download -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<script>
/* ====== CONFIG ====== */
const API_BASE = param('api') || 'https://oidwg6gcx0.execute-api.ap-south-1.amazonaws.com/PROD2';
const DEFAULT_EVENT_ID = param('event') || 'demo-2025-01';
const DEFAULT_SIM = Number(param('sim') || 70);
const DEBUG_MODE = param('debug') === '1';

/* ====== DOM ====== */
const $ = s=>document.querySelector(s);
const nameEl=$('#name'), mobileEl=$('#mobile'), video=$('#video'), canvas=$('#canvas');
const fileEl=$('#fileInput'), btnSnap=$('#btnSnap'), btnRetake=$('#btnRetake'), btnSearch=$('#btnSearch');
const selfieStatus=$('#selfieStatus'), resultsEl=$('#results'), emptyEl=$('#empty'), foundEl=$('#found');
const errBox=$('#errBox'), errText=$('#errText'), statusEl=$('#status');
const btnRunTests=$('#btnRunTests');
const btnZip=$('#btnZip'), selCount=$('#selCount'), btnClearSel=$('#btnClearSel');

/* ====== STATE ====== */
const state = { stream:null, imageBase64:'', imgBytes:0, selected:new Map() };

/* ====== HELPERS ====== */
function param(k){ const u=new URL(location.href); return u.searchParams.get(k); }
function stripDataUrl(d){ const i=d.indexOf(','); return i>-1?d.slice(i+1):d; }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
JSON.parseSafe = s=>{ try{return JSON.parse(s)}catch{return {}} };

/* ====== CAMERA ====== */
async function startCamera(){
  try{
    state.stream?.getTracks()?.forEach(t=>t.stop());
    const s = await navigator.mediaDevices.getUserMedia({ video:{facingMode:'user'}, audio:false });
    state.stream=s; video.srcObject=s; await video.play().catch(()=>{});
  }catch(e){ console.warn(e); statusMsg('कैमरा उपलब्ध नहीं—फ़ाइल से भी खोज कर सकते हैं।','warn'); }
}
function snapshot(){ const w=video.videoWidth||720,h=video.videoHeight||720; canvas.width=w; canvas.height=h; const c=canvas.getContext('2d'); c.drawImage(video,0,0,w,h); const data=canvas.toDataURL('image/jpeg',.9); state.imageBase64=stripDataUrl(data); state.imgBytes=Math.round((state.imageBase64.length*3)/4); }

/* ====== FILE ====== */
function fileToDataURL(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); }
async function useFile(file){ try{ const d=await fileToDataURL(file); const img=new Image(); await new Promise((r,j)=>{ img.onload=r; img.onerror=j; img.src=d; }); const w=img.width||720,h=img.height||720; canvas.width=w; canvas.height=h; canvas.getContext('2d').drawImage(img,0,0,w,h); const jpeg=canvas.toDataURL('image/jpeg',.9); state.imageBase64=stripDataUrl(jpeg); state.imgBytes=Math.round((state.imageBase64.length*3)/4); canvas.style.display='block'; video.style.display='none'; selfieStatus.textContent='सेल्फ़ी तैयार ✓'; }catch(err){ showErr('फ़ाइल पढ़ने में समस्या',err); } }

/* ====== EVENTS ====== */
btnSnap.addEventListener('click', async e=>{ e.preventDefault(); if(!video.srcObject){ await startCamera(); await sleep(200);} snapshot(); canvas.style.display='block'; video.style.display='none'; selfieStatus.textContent=`सेल्फ़ी तैयार ✓ (${state.imgBytes} bytes)`; });
btnRetake.addEventListener('click', e=>{ e.preventDefault(); canvas.style.display='none'; video.style.display='block'; state.imageBase64=''; selfieStatus.textContent='सेल्फ़ी फिर से लें या फ़ाइल चुनें।'; });
fileEl.addEventListener('change', e=>{ const f=e.target.files?.[0]; if(f) useFile(f); });
btnSearch.addEventListener('click', e=>{ e.preventDefault(); doSearch(); });
btnRunTests?.addEventListener('click', e=>{ e.preventDefault(); runTests(); });
btnClearSel.addEventListener('click', ()=>{ state.selected.clear(); updateSelBar(); resultsEl.querySelectorAll('.pCard').forEach(el=>el.classList.remove('sel')); });
btnZip.addEventListener('click', ()=>downloadSelectedZip());

/* ====== NETWORK ====== */
function statusMsg(msg,type='info'){ statusEl.textContent=msg||''; statusEl.className= type==='warn'?'warn':''; }
async function fetchSmart(url,opt={},timeoutMs=20000){ const ctrl=new AbortController(); const id=setTimeout(()=>ctrl.abort('timeout'),timeoutMs); try{ const resp=await fetch(url,{...opt,signal:ctrl.signal}); clearTimeout(id); const ct=(resp.headers.get('content-type')||'').toLowerCase(); let data; try{ data=ct.includes('application/json')?await resp.json():await resp.text(); }catch{ data='JSON parse error'; } return {ok:resp.ok,status:resp.status,data}; }catch(err){ clearTimeout(id); const reason=(err&&(err.name==='AbortError'||err==='timeout'))?'Request timed out':(err&&err.message)?err.message:String(err); return {ok:false,status:0,data:reason}; } }

function validMobile(m){ return /^\d{10}$/.test((m||'').trim()); }
async function doSearch(){ errBox.open=false; errText.textContent=''; const nm=(nameEl.value||'').trim(); const mb=(mobileEl.value||'').trim(); if(!nm){showMsg('कृपया नाम भरें।');return} if(!validMobile(mb)){showMsg('कृपया 10 अंकों का मोबाइल भरें।');return} if(!state.imageBase64){ if(video.srcObject){ snapshot(); canvas.style.display='block'; video.style.display='none'; } } if(!state.imageBase64){ showMsg('कृपया सेल्फ़ी लें या फ़ाइल चुनें।'); return; }
  btnSearch.disabled=true; showMsg('खोज जारी है…');
  const body={ eventId: DEFAULT_EVENT_ID, imageBase64: state.imageBase64, name: nm, mobile: mb, sim: DEFAULT_SIM };
  const r=await fetchSmart(API_BASE.replace(/\/$/,'')+'/search',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  if(!r.ok){ const hint=r.status===0?'नेटवर्क/CORS/टाइमआउट—URL, इंटरनेट या सर्वर CORS जाँचे।':`HTTP ${r.status}`; showMsg(`सर्वर में दिक्कत: ${hint}`,true); errText.textContent=(typeof r.data==='string')?r.data:JSON.stringify(r.data,null,2); errBox.open=true; btnSearch.disabled=false; return; }
  const payload=(typeof r.data==='string')?JSON.parseSafe(r.data):r.data; const items= payload?.items || payload?.results || payload?.matches || []; renderResults(items); const n=items.length|0; foundEl.style.display='block'; foundEl.textContent=`मिले ${n} फोटो।`; showMsg(''); btnSearch.disabled=false; }

function showMsg(msg,isErr=false){ if(isErr){ statusEl.innerHTML=`<div class="danger">${msg}</div>`; } else { statusEl.textContent=msg; } }
function showErr(title,err){ console.error(title,err); showMsg('नेटवर्क/ब्राउज़र एरर। बाद में फिर प्रयास करें।',true); errText.textContent=(err&&err.stack)?err.stack:String(err); errBox.open=true; }

/* ====== IMAGE PATHS ====== */
function getId(r){ return r.photoId || r.id || r.imageId || ''; }
function primaryKey(r){ return r.s3Key || r.key || r.s3key || r.path || r.urlKey || ''; }
function buildImgUrlFromKey(key){ return API_BASE.replace(/\/$/,'') + '/download?key=' + encodeURIComponent(key); }
function buildKeyCandidates(r){
  const prim=primaryKey(r); if(prim) return [prim];
  const ev=r.eventId || r.event || DEFAULT_EVENT_ID; let pid=getId(r) || r.filename || r.fileName || r.name || '';
  const keys=[]; const push=k=>{ if(k && !keys.includes(k)) keys.push(k); };
  if(pid && pid.includes('/')){ push(pid.startsWith('events/')?pid:`events/${ev}/${pid}`); }
  const hasExt=/\.(jpg|jpeg|png|webp)$/i.test(pid);
  const nameCandidates= hasExt? [pid] : [ pid+'.jpg', pid+'.jpeg', pid+'.png', pid+'.webp', pid+'.JPG', pid+'.JPEG', pid+'.PNG', pid+'.WEBP' ];
  const folders=['originals','', 'photos','images','img','raw','ORIGINALS','Photos','Images'];
  for(const f of folders){ for(const nm of nameCandidates){ push(`events/${ev}/${f?f+'/':''}${nm}`); } }
  return keys;
}

/* ====== RENDER & SELECTION ====== */
function tryNextImg(img){ let rest=[]; try{ rest=JSON.parse(img.dataset.keys||'[]'); }catch{} if(!rest.length){ const ph=document.createElement('div'); ph.className='thumb'; ph.style.display='flex'; ph.style.alignItems='center'; ph.style.justifyContent='center'; ph.style.color='#888'; ph.textContent='No preview'; img.replaceWith(ph); return; } const next=rest.shift(); img.dataset.keys=JSON.stringify(rest); img.src=buildImgUrlFromKey(next); }

function cardHTML(r){
  // hide ID & match text under photo; only the image + selection pill
  const keys=buildKeyCandidates(r); const first=keys[0]||''; const keyAttr= first || primaryKey(r) || '';
  const pickIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg>';
  return `
    <div class="pCard" data-key="${encodeURIComponent(keyAttr)}" onclick="toggleSelect(this)">
      ${ first
        ? `<img class="thumb" loading="lazy" alt="photo" src="${buildImgUrlFromKey(first)}" data-keys='${JSON.stringify(keys.slice(1))}' onerror="tryNextImg(this)">`
        : `<div class="thumb" style="display:flex;align-items:center;justify-content:center;color:#888">No preview</div>` }
      <div class="pick">${pickIcon}</div>
    </div>`;
}

function renderResults(items){
  state.selected.clear(); updateSelBar();
  if(!items || !items.length){ resultsEl.innerHTML=''; emptyEl.style.display='block'; return; }
  emptyEl.style.display='none'; resultsEl.innerHTML= items.map(cardHTML).join('');
}

function toggleSelect(card){
  const rawKey = decodeURIComponent(card.dataset.key||'');
  if(!rawKey) return;
  if(card.classList.contains('sel')){ card.classList.remove('sel'); state.selected.delete(rawKey); }
  else{ card.classList.add('sel'); state.selected.set(rawKey, true); }
  updateSelBar();
}

function updateSelBar(){ const n=state.selected.size; selCount.textContent = n+" selected"; btnZip.disabled = n===0; }

/* ====== ZIP DOWNLOAD ====== */
async function downloadSelectedZip(){
  if(state.selected.size===0) return;
  const zip = new JSZip();
  let i=0;
  for(const key of state.selected.keys()){
    try{
      const url = buildImgUrlFromKey(key);
      const resp = await fetch(url);
      const blob = await resp.blob();
      const ext = (blob.type && blob.type.includes('png'))? 'png' : (blob.type && blob.type.includes('webp'))? 'webp' : 'jpg';
      const safeName = key.split('/').pop() || `img_${(++i)}.${ext}`;
      zip.file(safeName, blob);
    }catch(e){ console.warn('skip', key, e); }
  }
  const out = await zip.generateAsync({type:'blob'});
  const fname = 'photos_'+ new Date().toISOString().slice(0,19).replace(/[:T]/g,'-') + '.zip';
  saveAs(out, fname);
}

/* ====== TESTS (optional) ====== */
function logTest(m){ console.log(m); }
async function runTests(){ logTest('self-tests ok'); }

/* ====== INIT ====== */
(async function init(){ if(param('name')) nameEl.value=param('name'); if(param('mobile')) mobileEl.value=param('mobile'); await startCamera(); window.addEventListener('focus',()=>{ if(!video.srcObject) startCamera().catch(()=>{}); }); })();
</script>
</body>
</html>
